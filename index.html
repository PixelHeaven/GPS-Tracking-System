<!DOCTYPE html>
<html>
<head>
  <title>GPX Tracker Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <h1>GPS Tracker</h1>
  <button onclick="startTracking()">Start Tracking</button>
  <button onclick="stopTracking()">Stop & Download GPX</button>
  <p id="status">Status: Not started</p>
  <ul id="log"></ul>

  <script>
    let watchId;
    let trackPoints = [];

    function startTracking() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      document.getElementById("status").textContent = "Status: Tracking...";

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const time = new Date().toISOString();

          trackPoints.push({ lat, lon, time });

          const logItem = document.createElement("li");
          logItem.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)} @ ${time}`;
          document.getElementById("log").appendChild(logItem);
        },
        (err) => {
          alert("Error getting position: " + err.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    function stopTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        document.getElementById("status").textContent = "Status: Stopped";
        generateGPX();
      }
    }

    function generateGPX() {
      let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="GPX Tracker" xmlns="http://www.topografix.com/GPX/1/1">
<trk><name>GPS Track</name><trkseg>
`;

      trackPoints.forEach(pt => {
        gpx += `<trkpt lat="${pt.lat}" lon="${pt.lon}"><time>${pt.time}</time></trkpt>\n`;
      });

      gpx += `</trkseg></trk></gpx>`;

      const blob = new Blob([gpx], { type: "application/gpx+xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "track.gpx";
      a.click();
    }
  </script>
</body>
</html>
