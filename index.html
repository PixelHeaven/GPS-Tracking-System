<!DOCTYPE html>
<html>
<head>
  <title>KML GPS Tracker (Advanced)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
    }
    #log {
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      background: #f9f9f9;
      font-size: 14px;
    }
    #status {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üìç KML GPS Tracker (Advanced)</h1>
  <button onclick="startTracking()">Start Tracking</button>
  <button onclick="stopTracking()">Stop & Download KML</button>
  <p id="status">Status: Not started</p>
  <div id="log"></div>

  <script>
    let watchId;
    let coordinates = [];
    let lastGoodPoint = null;

    function startTracking() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      coordinates = [];
      lastGoodPoint = null;
      document.getElementById("log").innerHTML = "";
      document.getElementById("status").textContent = "Status: Tracking...";

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const alt = position.coords.altitude ?? 0;
          const acc = position.coords.accuracy;
          const speed = position.coords.speed ?? 0;
          const time = new Date().toISOString();

          if (acc > 25) {
            log(`‚ö†Ô∏è Ignored: Accuracy too low (${Math.round(acc)}m)`);
            return;
          }

          const point = { lat, lon, alt, time };

          if (lastGoodPoint && !hasMovedEnough(lastGoodPoint, point)) {
            log(`üî∏ Skipped: No significant movement`);
            return;
          }

          lastGoodPoint = point;

          const kmlCoord = `${lon},${lat},${alt}`;
          coordinates.push(kmlCoord);

          log(`‚úÖ Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}, Alt: ${Math.round(alt)}m, Speed: ${Math.round(speed * 3.6)} km/h (¬±${Math.round(acc)}m)`);
        },
        (err) => {
          alert("Error getting position: " + err.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
    }

    function stopTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        document.getElementById("status").textContent = "Status: Stopped";
        generateKML();
      }
    }

    function generateKML() {
      if (coordinates.length === 0) {
        alert("No usable GPS points were collected.");
        return;
      }

      let kml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
      kml += `<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<Placemark>\n`;
      kml += `<name>GPS Track</name>\n`;
      kml += `<Style><LineStyle><color>ff0000ff</color><width>4</width></LineStyle></Style>\n`;
      kml += `<LineString><tessellate>1</tessellate><coordinates>\n`;
      kml += coordinates.join("\n") + "\n";
      kml += `</coordinates></LineString>\n`;
      kml += `</Placemark>\n</Document>\n</kml>`;

      const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'track.kml';
      a.click();
    }

    function log(msg) {
      const logDiv = document.getElementById("log");
      const p = document.createElement("p");
      p.textContent = msg;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function hasMovedEnough(last, current) {
      const deltaLat = Math.abs(last.lat - current.lat);
      const deltaLon = Math.abs(last.lon - current.lon);
      return deltaLat > 0.00002 || deltaLon > 0.00002; // ~2m movement
    }
  </script>
</body>
</html>
