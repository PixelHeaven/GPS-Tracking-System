<!DOCTYPE html>
<html>
<head>
  <title>Smart KML GPS Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    #log { max-height: 250px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px; background: #f9f9f9; font-size: 14px; }
    #status { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üìç Smart KML GPS Tracker</h1>
  <button onclick="startTracking()">Start Tracking</button>
  <button onclick="stopTracking()">Stop & Download KML</button>
  <p id="status">Status: Not started</p>
  <div id="log"></div>

  <script>
    let watchId;
    let coordinates = [];
    let buffer = []; // recent points buffer
    const bufferSize = 5;
    const accuracyLimit = 25;
    const logDistanceThreshold = 10; // meters

    function startTracking() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      coordinates = [];
      buffer = [];
      document.getElementById("log").innerHTML = "";
      document.getElementById("status").textContent = "Status: Tracking...";

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const { latitude: lat, longitude: lon, altitude, accuracy, speed } = position.coords;
          const alt = altitude ?? 0;
          const spd = speed ?? 0;
          const time = new Date().toISOString();

          if (accuracy > accuracyLimit) {
            log(`‚ö†Ô∏è Ignored (Low accuracy: ${Math.round(accuracy)}m)`);
            return;
          }

          const point = { lat, lon, alt, accuracy, time };

          // Add to buffer
          buffer.push(point);
          if (buffer.length > bufferSize) buffer.shift();

          // Compute average of buffered points
          const avg = averageCoords(buffer);

          const distFromAvg = distanceInMeters(lat, lon, avg.lat, avg.lon);

          if (distFromAvg < logDistanceThreshold && coordinates.length > 0) {
            log(`üî∏ Skipped (within ${distFromAvg.toFixed(1)}m of average)`);
            return;
          }

          const kmlCoord = `${lon},${lat},${alt}`;
          coordinates.push(kmlCoord);

          log(`‚úÖ ${lat.toFixed(5)}, ${lon.toFixed(5)} | Alt: ${Math.round(alt)}m | Speed: ${Math.round(spd * 3.6)} km/h | ¬±${Math.round(accuracy)}m`);
        },
        (err) => {
          alert("Error getting position: " + err.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
    }

    function stopTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        document.getElementById("status").textContent = "Status: Stopped";
        generateKML();
      }
    }

    function generateKML() {
      if (coordinates.length === 0) {
        alert("No usable GPS points were collected.");
        return;
      }

      let kml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
      kml += `<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<Placemark>\n`;
      kml += `<name>GPS Track</name>\n`;
      kml += `<Style><LineStyle><color>ff0000ff</color><width>4</width></LineStyle></Style>\n`;
      kml += `<LineString><tessellate>1</tessellate><coordinates>\n`;
      kml += coordinates.join("\n") + "\n";
      kml += `</coordinates></LineString>\n`;
      kml += `</Placemark>\n</Document>\n</kml>`;

      const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'track.kml';
      a.click();
    }

    function log(msg) {
      const logDiv = document.getElementById("log");
      const p = document.createElement("p");
      p.textContent = msg;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function averageCoords(points) {
      const sum = points.reduce((acc, p) => {
        acc.lat += p.lat;
        acc.lon += p.lon;
        return acc;
      }, { lat: 0, lon: 0 });
      return {
        lat: sum.lat / points.length,
        lon: sum.lon / points.length
      };
    }

    function distanceInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth radius in meters
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
  </script>
</body>
</html>
