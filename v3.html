<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2196f3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ultra GPS Tracker Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            padding: 10px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
            padding: 10px;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(45deg, #2196f3, #21cbf3);
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 1rem;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-content {
            padding: 15px;
        }
        
        /* Mobile-optimized buttons */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-group.single {
            grid-template-columns: 1fr;
        }
        
        .btn-group.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 44px; /* iOS touch target minimum */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #9e9e9e, #757575);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Status indicators */
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status.active {
            background: #4caf50;
            color: white;
        }
        
        .status.inactive {
            background: #9e9e9e;
            color: white;
        }
        
        .status.online {
            background: #4caf50;
            color: white;
        }
        
        .status.offline {
            background: #f44336;
            color: white;
        }
        
        /* Accuracy indicators */
        .accuracy-indicator {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            margin: 10px 0;
        }
        
        .accuracy-excellent {
            background: #4caf50;
            color: white;
        }
        
        .accuracy-good {
            background: #8bc34a;
            color: white;
        }
        
        .accuracy-fair {
            background: #ff9800;
            color: white;
        }
        
        .accuracy-poor {
            background: #f44336;
            color: white;
        }
        
        /* Data mode indicators */
        .offline-indicator {
            background: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .data-saver-active {
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* Coordinates display */
        .coordinates-display {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
            margin: 10px 0;
            word-break: break-all;
        }
        
        /* Map container */
        .map-container {
            height: 250px;
            background: #f0f0f0;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .map-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 0.9rem;
        }
        
        #trackCanvas {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .metric-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }
        
        /* Sensor data */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 10px 0;
        }
        
        .sensor-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .sensor-label {
            font-size: 0.6rem;
            color: #666;
            margin-bottom: 2px;
        }
        
        .sensor-value {
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        /* Progress bars */
        .progress-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 6px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #4caf50, #45a049);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            background: linear-gradient(45deg, #2196f3, #21cbf3);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .close:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
            min-height: 44px; /* iOS touch target */
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2196f3;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        /* Error notifications */
        .error-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 90%;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .error-content button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 8px;
            cursor: pointer;
        }
        
        /* Collapsible sections */
        .collapsible {
            cursor: pointer;
            padding: 10px 15px;
            background: #f8f9fa;
            border: none;
            text-align: left;
            width: 100%;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .collapsible:hover {
            background: #e9ecef;
        }
        
        .collapsible.active {
            background: #2196f3;
            color: white;
        }
        
                .collapsible-content {
            display: none;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .collapsible-content.active {
            display: block;
        }
        
        .chevron {
            transition: transform 0.3s ease;
        }
        
        .chevron.active {
            transform: rotate(180deg);
        }
        
        /* Responsive design */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .btn-group.triple {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .sensor-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                margin: 2% auto;
                width: 98%;
                max-height: 96vh;
            }
            
            .coordinates-display {
                font-size: 0.7rem;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            }
            
            .card {
                background: #2c3e50;
                color: white;
            }
            
            .coordinates-display {
                background: #34495e;
                color: white;
            }
            
            .metric-item, .sensor-item {
                background: #34495e;
                color: white;
            }
            
            .form-control {
                background: #34495e;
                color: white;
                border-color: #4a5568;
            }
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Touch feedback */
        .btn:active {
            transform: scale(0.98);
        }
        
        /* Swipe indicator */
        .swipe-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛰️ Ultra GPS Tracker Pro</h1>
            <div class="subtitle">Professional GPS Tracking & Analysis</div>
        </div>
        
        <!-- Main Controls -->
        <div class="card">
            <div class="card-header">
                <span>📍 Tracking Controls</span>
                <span id="trackingStatus" class="status inactive">Inactive</span>
            </div>
            <div class="card-content">
                <div class="btn-group">
                    <button id="startBtn" class="btn btn-primary" onclick="startTracking()">
                        ▶️ Start
                    </button>
                    <button id="stopBtn" class="btn btn-danger" onclick="stopTracking()" disabled>
                        ⏹️ Stop
                    </button>
                </div>
                <div class="btn-group">
                    <button id="pauseBtn" class="btn btn-warning" onclick="pauseTracking()" disabled>
                        ⏸️ Pause
                    </button>
                    <button id="resumeBtn" class="btn btn-primary" onclick="resumeTracking()" disabled style="display: none;">
                        ▶️ Resume
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()">
                        🗑️ Clear
                    </button>
                </div>
                <div class="btn-group single">
                    <button class="btn btn-info" onclick="showSettings()">
                        ⚙️ Settings & Export
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Connection Status -->
        <div class="card">
            <div class="card-header">
                <span>🌐 Connection Status</span>
                <span id="connectionStatus" class="status offline">Checking...</span>
            </div>
            <div class="card-content">
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">Connection</div>
                        <div class="metric-value" id="connectionType">Unknown</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Data Mode</div>
                        <div class="metric-value" id="dataSavingMode">Full</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Data Used</div>
                        <div class="metric-value" id="dataUsed">0 KB</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Estimated Savings</div>
                        <div class="metric-value" id="dataSavings">0 KB</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Current Position -->
        <div class="card">
            <div class="card-header">
                <span>📍 Current Position</span>
            </div>
            <div class="card-content">
                <div id="accuracyIndicator" class="accuracy-indicator accuracy-poor">
                    Accuracy: Initializing...
                </div>
                <div id="coordinatesDisplay" class="coordinates-display">
                    LAT: -.--------° LON: -.--------°<br>
                    ALT: ---.- m  ACC: ---.- m<br>
                    SPD: --.- km/h  HDG: ---°<br>
                    UTC: ----/--/-- --:--:--
                </div>
            </div>
        </div>
        
        <!-- Track Visualization -->
        <div class="card">
            <div class="card-header">
                <span>🗺️ Track Map</span>
            </div>
            <div class="card-content">
                <div id="mapContainer" class="map-container">
                    <div class="map-placeholder">
                        📍 Track will appear here when GPS is active
                    </div>
                    <canvas id="trackCanvas"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="card">
            <div class="card-header">
                <span>📊 Track Statistics</span>
            </div>
            <div class="card-content">
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">Points</div>
                        <div class="metric-value" id="pointCount">0 points</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Distance</div>
                        <div class="metric-value" id="totalDistance">0.000 km</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Duration</div>
                        <div class="metric-value" id="duration">00:00:00</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Avg Speed</div>
                        <div class="metric-value" id="avgSpeed">0.00 km/h</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Max Speed</div>
                        <div class="metric-value" id="maxSpeed">0.00 km/h</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Elevation ↗️</div>
                        <div class="metric-value" id="elevGain">0 m</div>
                    </div>
                </div>
                
                <!-- Progress indicators -->
                <div style="margin-top: 15px;">
                    <div class="metric-label">Distance Progress (10km goal)</div>
                    <div class="progress-container">
                        <div id="distanceProgress" class="progress-bar"></div>
                    </div>
                    
                    <div class="metric-label" style="margin-top: 10px;">Speed Progress (50km/h goal)</div>
                    <div class="progress-container">
                        <div id="speedProgress" class="progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Collapsible Advanced Sections -->
        <div class="card">
            <button class="collapsible" onclick="toggleCollapsible(this)">
                🔧 GPS Details
                <span class="chevron">▼</span>
            </button>
            <div class="collapsible-content">
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">H. Accuracy</div>
                        <div class="metric-value" id="hAccuracy">- m</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">V. Accuracy</div>
                        <div class="metric-value" id="vAccuracy">- m</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">HDOP</div>
                        <div class="metric-value" id="hdop">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">PDOP</div>
                        <div class="metric-value" id="pdop">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Fix Type</div>
                        <div class="metric-value" id="fixType">None</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Satellites</div>
                        <div class="metric-value" id="satelliteCount">0 sats</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <button class="collapsible" onclick="toggleCollapsible(this)">
                📱 Sensor Data
                <span class="chevron">▼</span>
            </button>
            <div class="collapsible-content">
                <div class="metric-label">Accelerometer (m/s²)</div>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <div class="sensor-label">X</div>
                        <div class="sensor-value" id="accelX">0.00</div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Y</div>
                        <div class="sensor-value" id="accelY">0.00</div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Z</div>
                        <div class="sensor-value" id="accelZ">0.00</div>
                    </div>
                </div>
                
                <div class="metric-label" style="margin-top: 15px;">Gyroscope (°/s)</div>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <div class="sensor-label">X</div>
                        <div class="sensor-value" id="gyroX">0.00</div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Y</div>
                        <div class="sensor-value" id="gyroY">0.00</div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Z</div>
                        <div class="sensor-value" id="gyroZ">0.00</div>
                    </div>
                </div>
                
                <div class="metrics-grid" style="margin-top: 15px;">
                    <div class="metric-item">
                        <div class="metric-label">Motion</div>
                        <div class="metric-value" id="motionState">Stationary</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Activity</div>
                        <div class="metric-value" id="activityType">Unknown</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <button class="collapsible" onclick="toggleCollapsible(this)">
                🎯 Track Quality
                <span class="chevron">▼</span>
            </button>
            <div class="collapsible-content">
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">Precision</div>
                        <div class="metric-value" id="trackPrecision">-%</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Smoothness</div>
                        <div class="metric-value" id="trackSmoothness">-%</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Fusion Status</div>
                        <div class="metric-value" id="fusionStatus">Inactive</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Kalman Filter</div>
                        <div class="metric-value" id="kalmanStatus">Inactive</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Settings & Export</h2>
                <button class="close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Export Section -->
                <div class="form-group">
                    <label class="form-label">📤 Export Track Data</label>
                    <div class="btn-group triple">
                        <button id="exportGpxBtn" class="btn btn-info" onclick="exportGPX()" disabled>
                            GPX
                        </button>
                        <button id="exportKmlBtn" class="btn btn-info" onclick="exportKML()" disabled>
                            KML
                        </button>
                        <button id="exportJsonBtn" class="btn btn-info" onclick="exportJSON()" disabled>
                            JSON
                        </button>
                    </div>
                </div>
                
                <!-- GPS Settings -->
                <div class="form-group">
                    <label class="form-label">🛰️ GPS Settings</label>
                    
                    <label class="form-label">Update Interval (ms)</label>
                    <select id="gpsInterval" class="form-control">
                        <option value="1000">1 second (High precision)</option>
                        <option value="2000">2 seconds (Balanced)</option>
                        <option value="5000" selected>5 seconds (Battery saver)</option>
                        <option value="10000">10 seconds (Minimal)</option>
                    </select>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="highAccuracy" checked>
                        <label for="highAccuracy">High Accuracy Mode</label>
                    </div>
                    
                    <label class="form-label">Position Timeout (ms)</label>
                    <input type="number" id="positionTimeout" class="form-control" value="15000" min="5000" max="60000">
                    
                    <label class="form-label">Maximum Age (ms)</label>
                    <input type="number" id="maximumAge" class="form-control" value="10000" min="0" max="300000">
                </div>
                
                <!-- Filtering Settings -->
                <div class="form-group">
                    <label class="form-label">🎯 Data Filtering</label>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="sensorFusion" checked>
                        <label for="sensorFusion">Sensor Fusion</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="trackSmoothing" checked>
                        <label for="trackSmoothing">Kalman Filter Smoothing</label>
                    </div>
                    
                    <label class="form-label">Minimum Accuracy (meters)</label>
                    <input type="number" id="minAccuracy" class="form-control" value="50" min="1" max="1000">
                    
                    <label class="form-label">Minimum Distance (meters)</label>
                    <input type="number" id="minDistance" class="form-control" value="5" min="0" max="100">
                </div>
                
                <!-- Data Usage Settings -->
                <div class="form-group">
                    <label class="form-label">📊 Data Usage</label>
                    
                    <label class="form-label">Data Saving Mode</label>
                    <select id="dataSavingMode" class="form-control">
                        <option value="full">Full Features</option>
                        <option value="minimal" selected>Minimal Data Usage</option>
                        <option value="offline">Offline Only</option>
                    </select>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableMapTiles">
                        <label for="enableMapTiles">Enable Map Tiles (requires internet)</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableElevationAPI">
                        <label for="enableElevationAPI">Enhanced Elevation Data</label>
                    </div>
                </div>
                
                <!-- Advanced Settings -->
                <div class="form-group">
                    <label class="form-label">🔧 Advanced</label>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableCloudSync">
                        <label for="enableCloudSync">Cloud Sync (when available)</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableWeatherData">
                        <label for="enableWeatherData">Weather Data Integration</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="deadReckoning">
                        <label for="deadReckoning">Dead Reckoning (experimental)</label>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        💾 Save Settings
                    </button>
                    <button class="btn btn-secondary" onclick="closeSettings()">
                        ❌ Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class UltraGPSTracker {
            constructor() {
                this.isTracking = false;
                this.isPaused = false;
                this.watchId = null;
                this.trackData = [];
                this.filteredData = [];
                this.sensorData = [];
                this.startTime = null;
                this.pausedTime = 0;
                this.pauseStartTime = null;
                
                // Statistics
                this.totalDistance = 0;
                this.maxSpeed = 0;
                this.elevationGain = 0;
                this.elevationLoss = 0;
                this.lastElevation = null;
                
                // Map bounds
                this.mapBounds = {
                    minLat: 90, maxLat: -90,
                    minLon: 180, maxLon: -180
                };
                
                // Kalman filter
                this.kalmanFilter = {
                    Q: 0.1, R: 1.0, P: 1.0, K: 0.0, x: 0.0
                };
                
                // Data usage tracking
                this.dataUsage = {
                    total: 0,
                    saved: 0,
                    mode: 'minimal'
                };
                
                // Connection monitoring
                this.connectionInfo = {
                    online: navigator.onLine,
                    type: 'unknown',
                    effectiveType: 'unknown'
                };
                
                // Wake lock
                this.wakeLock = null;
                
                // Initialize
                this.init();
            }
            
            async init() {
                try {
                    // Setup canvas
                    this.setupCanvas();
                    
                    // Load settings
                    this.loadSettings();
                    
                    // Setup sensors
                    await this.setupSensors();
                    
                    // Setup connection monitoring
                    this.setupConnectionMonitoring();
                    
                    // Start status updates
                    this.startStatusUpdates();
                    
                    // Update UI
                    this.updateTrackingUI();
                    
                    console.log('Ultra GPS Tracker Pro initialized successfully');
                    
                    // Show swipe hint on mobile
                    if (this.isMobile()) {
                        this.showSwipeHint();
                    }
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showError('Failed to initialize GPS tracker: ' + error.message);
                }
            }
            
            isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }
            
            showSwipeHint() {
                const hint = document.createElement('div');
                hint.className = 'swipe-hint';
                hint.textContent = '👆 Swipe right to start, left to pause, up for settings';
                document.body.appendChild(hint);
                
                setTimeout(() => {
                    if (hint.parentElement) {
                        hint.remove();
                    }
                }, 3000);
            }
            
            setupCanvas() {
                this.canvas = document.getElementById('trackCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                const container = document.getElementById('mapContainer');
                this.canvas.width = container.offsetWidth;
                this.canvas.height = container.offsetHeight;
                
                // High DPI support
                const dpr = window.devicePixelRatio || 1;
                const rect = this.canvas.getBoundingClientRect();
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.ctx.scale(dpr, dpr);
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
            }
            
            async setupSensors() {
                try {
                    // Request sensor permissions
                    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission !== 'granted') {
                            console.warn('Device motion permission denied');
                            return;
                        }
                    }
                    
                    // Setup accelerometer
                    if (window.DeviceMotionEvent) {
                        window.addEventListener('devicemotion', (event) => {
                            this.handleSensorData('accelerometer', event.acceleration);
                            this.handleSensorData('gyroscope', event.rotationRate);
                        });
                    }
                    
                    // Setup orientation
                    if (window.DeviceOrientationEvent) {
                        window.addEventListener('deviceorientation', (event) => {
                            this.handleSensorData('orientation', {
                                alpha: event.alpha,
                                beta: event.beta,
                                gamma: event.gamma
                            });
                        });
                    }
                    
                    console.log('Sensors initialized');
                } catch (error) {
                    console.warn('Sensor setup failed:', error);
                }
            }
            
            handleSensorData(type, data) {
                if (!data) return;
                
                const timestamp = Date.now();
                const sensorReading = { type, data, timestamp };
                
                // Store sensor data
                this.sensorData.push(sensorReading);
                
                // Keep only recent data (last 100 readings)
                if (this.sensorData.length > 100) {
                    this.sensorData.shift();
                }
                
                // Update display
                this.updateSensorDisplay(type, data);
                
                // Update motion detection
                this.updateMotionDetection(data);
            }
            
            updateSensorDisplay(type, data) {
                try {
                    switch (type) {
                        case 'accelerometer':
                            if (data.x !== null) document.getElementById('accelX').textContent = data.x.toFixed(2);
                            if (data.y !== null) document.getElementById('accelY').textContent = data.y.toFixed(2);
                            if (data.z !== null) document.getElementById('accelZ').textContent = data.z.toFixed(2);
                            break;
                        case 'gyroscope':
                            if (data.alpha !== null) document.getElementById('gyroX').textContent = data.alpha.toFixed(2);
                            if (data.beta !== null) document.getElementById('gyroY').textContent = data.beta.toFixed(2);
                            if (data.gamma !== null) document.getElementById('gyroZ').textContent = data.gamma.toFixed(2);
                            break;
                        case 'orientation':
                            if (data.alpha !== null) document.getElementById('orientAlpha').textContent = Math.round(data.alpha) + '°';
                            if (data.beta !== null) document.getElementById('orientBeta').textContent = Math.round(data.beta) + '°';
                            if (data.gamma !== null) document.getElementById('orientGamma').textContent = Math.round(data.gamma) + '°';
                            break;
                    }
                } catch (error) {
                    // Silently handle missing elements
                }
            }
            
            updateMotionDetection(data) {
                if (!data || typeof data.x !== 'number') return;
                
                const magnitude = Math.sqrt(data.x * data.x + data.y * data.y + data.z * data.z);
                
                let motionState = 'Stationary';
                let activityType = 'Unknown';
                
                if (magnitude > 15) {
                    motionState = 'High Motion';
                    activityType = 'Running';
                } else if (magnitude > 5) {
                    motionState = 'Moderate Motion';
                    activityType = 'Walking';
                } else if (magnitude > 1) {
                    motionState = 'Low Motion';
                    activityType = 'Idle';
                }
                
                // Update display
                const motionElement = document.getElementById('motionState');
                const activityElement = document.getElementById('activityType');
                if (motionElement) motionElement.textContent = motionState;
                if (activityElement) activityElement.textContent = activityType;
            }
            
            setupConnectionMonitoring() {
                // Online/offline events
                window.addEventListener('online', () => {
                    this.connectionInfo.online = true;
                    this.updateConnectionDisplay();
                    console.log('Connection restored');
                });
                
                window.addEventListener('offline', () => {
                    this.connectionInfo.online = false;
                    this.updateConnectionDisplay();
                    console.log('Connection lost - switching to offline mode');
                    this.setDataSavingMode('offline');
                });
                
                // Network Information API
                if ('connection' in navigator) {
                    const connection = navigator.connection;
                    
                    const updateConnectionInfo = () => {
                        this.connectionInfo.type = connection.type || 'unknown';
                        this.connectionInfo.effectiveType = connection.effectiveType || 'unknown';
                        this.updateConnectionDisplay();
                        
                        // Auto-adjust data saving mode based on connection
                        if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                            this.setDataSavingMode('minimal');
                        }
                    };
                    
                    connection.addEventListener('change', updateConnectionInfo);
                    updateConnectionInfo();
                }
                
                // Initial update
                this.updateConnectionDisplay();
            }
            
                        updateConnectionDisplay() {
                const statusElement = document.getElementById('connectionStatus');
                const typeElement = document.getElementById('connectionType');
                const modeElement = document.getElementById('dataSavingMode');
                const usedElement = document.getElementById('dataUsed');
                const savingsElement = document.getElementById('dataSavings');
                
                if (statusElement) {
                    statusElement.textContent = this.connectionInfo.online ? 'Online' : 'Offline';
                    statusElement.className = this.connectionInfo.online ? 'status online' : 'status offline';
                }
                
                if (typeElement) {
                    const connectionType = this.connectionInfo.effectiveType || this.connectionInfo.type || 'Unknown';
                    typeElement.textContent = connectionType.toUpperCase();
                }
                
                if (modeElement) {
                    modeElement.textContent = this.dataUsage.mode.charAt(0).toUpperCase() + this.dataUsage.mode.slice(1);
                }
                
                if (usedElement) {
                    usedElement.textContent = this.formatDataSize(this.dataUsage.total);
                }
                
                if (savingsElement) {
                    savingsElement.textContent = this.formatDataSize(this.dataUsage.saved);
                }
            }
            
            formatDataSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }
            
            setDataSavingMode(mode) {
                this.dataUsage.mode = mode;
                
                // Update settings
                const modeSelect = document.getElementById('dataSavingMode');
                if (modeSelect) {
                    modeSelect.value = mode;
                }
                
                console.log(`Data saving mode set to: ${mode}`);
                this.updateConnectionDisplay();
            }
            
            trackDataUsage(bytes) {
                this.dataUsage.total += bytes;
                
                // Calculate savings based on mode
                if (this.dataUsage.mode === 'minimal') {
                    this.dataUsage.saved += bytes * 0.7; // Assume 70% savings
                } else if (this.dataUsage.mode === 'offline') {
                    this.dataUsage.saved += bytes; // 100% savings
                }
                
                this.updateConnectionDisplay();
            }
            
            async startTracking() {
                if (this.isTracking) return;
                
                try {
                    // Check geolocation support
                    if (!navigator.geolocation) {
                        throw new Error('Geolocation is not supported by this browser');
                    }
                    
                    // Request wake lock
                    await this.requestWakeLock();
                    
                    // Get settings
                    const settings = this.getGPSSettings();
                    
                    // Start watching position
                    this.watchId = navigator.geolocation.watchPosition(
                        (position) => this.handlePositionUpdate(position),
                        (error) => this.handlePositionError(error),
                        settings
                    );
                    
                    // Update state
                    this.isTracking = true;
                    this.isPaused = false;
                    this.startTime = Date.now();
                    this.pausedTime = 0;
                    
                    // Update UI
                    this.updateTrackingUI();
                    
                    console.log('GPS tracking started');
                    this.showNotification('GPS tracking started', 'success');
                    
                } catch (error) {
                    console.error('Failed to start tracking:', error);
                    this.showError('Failed to start GPS tracking: ' + error.message);
                }
            }
            
            stopTracking() {
                if (!this.isTracking) return;
                
                // Stop watching position
                if (this.watchId !== null) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
                
                // Release wake lock
                this.releaseWakeLock();
                
                // Update state
                this.isTracking = false;
                this.isPaused = false;
                
                // Update UI
                this.updateTrackingUI();
                
                console.log('GPS tracking stopped');
                this.showNotification('GPS tracking stopped', 'info');
            }
            
            pauseTracking() {
                if (!this.isTracking || this.isPaused) return;
                
                this.isPaused = true;
                this.pauseStartTime = Date.now();
                
                // Stop GPS updates but keep tracking state
                if (this.watchId !== null) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
                
                this.updateTrackingUI();
                console.log('GPS tracking paused');
                this.showNotification('GPS tracking paused', 'warning');
            }
            
            resumeTracking() {
                if (!this.isTracking || !this.isPaused) return;
                
                // Calculate paused time
                if (this.pauseStartTime) {
                    this.pausedTime += Date.now() - this.pauseStartTime;
                    this.pauseStartTime = null;
                }
                
                this.isPaused = false;
                
                // Resume GPS updates
                const settings = this.getGPSSettings();
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => this.handlePositionUpdate(position),
                    (error) => this.handlePositionError(error),
                    settings
                );
                
                this.updateTrackingUI();
                console.log('GPS tracking resumed');
                this.showNotification('GPS tracking resumed', 'success');
            }
            
            getGPSSettings() {
                const highAccuracy = document.getElementById('highAccuracy')?.checked ?? true;
                const timeout = parseInt(document.getElementById('positionTimeout')?.value) || 15000;
                const maximumAge = parseInt(document.getElementById('maximumAge')?.value) || 10000;
                
                return {
                    enableHighAccuracy: highAccuracy,
                    timeout: timeout,
                    maximumAge: maximumAge
                };
            }
            
            handlePositionUpdate(position) {
                if (!this.isTracking || this.isPaused) return;
                
                const coords = position.coords;
                const timestamp = position.timestamp;
                
                // Create GPS point
                const gpsPoint = {
                    latitude: coords.latitude,
                    longitude: coords.longitude,
                    altitude: coords.altitude,
                    accuracy: coords.accuracy,
                    altitudeAccuracy: coords.altitudeAccuracy,
                    heading: coords.heading,
                    speed: coords.speed,
                    timestamp: timestamp
                };
                
                // Add to raw data
                this.trackData.push(gpsPoint);
                
                // Apply filtering
                const filteredPoint = this.applyFiltering(gpsPoint);
                if (filteredPoint) {
                    this.filteredData.push(filteredPoint);
                    
                    // Update statistics
                    this.updateStatistics(filteredPoint);
                    
                    // Update map bounds
                    this.updateMapBounds(filteredPoint);
                    
                    // Draw track
                    this.drawTrack();
                }
                
                // Update displays
                this.updateCoordinatesDisplay(gpsPoint);
                this.updateAccuracyIndicator(coords.accuracy);
                this.updateStatisticsDisplay();
                
                // Enable export buttons
                this.enableExportButtons();
            }
            
            applyFiltering(point) {
                const minAccuracy = parseFloat(document.getElementById('minAccuracy')?.value) || 50;
                const minDistance = parseFloat(document.getElementById('minDistance')?.value) || 5;
                const useKalman = document.getElementById('trackSmoothing')?.checked ?? true;
                
                // Accuracy filter
                if (point.accuracy > minAccuracy) {
                    console.log(`Point rejected: accuracy ${point.accuracy}m > ${minAccuracy}m`);
                    return null;
                }
                
                // Distance filter
                if (this.filteredData.length > 0) {
                    const lastPoint = this.filteredData[this.filteredData.length - 1];
                    const distance = this.calculateDistance(
                        lastPoint.latitude, lastPoint.longitude,
                        point.latitude, point.longitude
                    );
                    
                    if (distance < minDistance) {
                        console.log(`Point rejected: distance ${distance}m < ${minDistance}m`);
                        return null;
                    }
                }
                
                // Apply Kalman filter
                let filteredPoint = { ...point };
                if (useKalman) {
                    filteredPoint = this.applyKalmanFilter(point);
                }
                
                return filteredPoint;
            }
            
            applyKalmanFilter(point) {
                // Simple Kalman filter for latitude (can be extended for longitude)
                const measurement = point.latitude;
                const measurementNoise = point.accuracy / 111000; // Convert meters to degrees
                
                // Prediction step
                this.kalmanFilter.P += this.kalmanFilter.Q;
                
                // Update step
                this.kalmanFilter.K = this.kalmanFilter.P / (this.kalmanFilter.P + measurementNoise);
                this.kalmanFilter.x += this.kalmanFilter.K * (measurement - this.kalmanFilter.x);
                this.kalmanFilter.P *= (1 - this.kalmanFilter.K);
                
                // Update display
                const kalmanStatus = document.getElementById('kalmanStatus');
                const kalmanGain = document.getElementById('kalmanGain');
                const kalmanError = document.getElementById('kalmanError');
                
                if (kalmanStatus) kalmanStatus.textContent = 'Active';
                if (kalmanGain) kalmanGain.textContent = this.kalmanFilter.K.toFixed(3);
                if (kalmanError) kalmanError.textContent = this.kalmanFilter.P.toFixed(3);
                
                return {
                    ...point,
                    latitude: this.kalmanFilter.x || point.latitude
                };
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000; // Earth's radius in meters
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            updateStatistics(point) {
                // Update distance
                if (this.filteredData.length > 1) {
                    const prevPoint = this.filteredData[this.filteredData.length - 2];
                    const distance = this.calculateDistance(
                        prevPoint.latitude, prevPoint.longitude,
                        point.latitude, point.longitude
                    );
                    this.totalDistance += distance / 1000; // Convert to km
                }
                
                // Update max speed
                if (point.speed !== null && point.speed > this.maxSpeed) {
                    this.maxSpeed = point.speed * 3.6; // Convert m/s to km/h
                }
                
                // Update elevation
                if (point.altitude !== null) {
                    if (this.lastElevation !== null) {
                        const elevDiff = point.altitude - this.lastElevation;
                        if (elevDiff > 0) {
                            this.elevationGain += elevDiff;
                        } else {
                            this.elevationLoss += Math.abs(elevDiff);
                        }
                    }
                    this.lastElevation = point.altitude;
                }
            }
            
            updateMapBounds(point) {
                this.mapBounds.minLat = Math.min(this.mapBounds.minLat, point.latitude);
                this.mapBounds.maxLat = Math.max(this.mapBounds.maxLat, point.latitude);
                this.mapBounds.minLon = Math.min(this.mapBounds.minLon, point.longitude);
                this.mapBounds.maxLon = Math.max(this.mapBounds.maxLon, point.longitude);
            }
            
            drawTrack() {
                if (this.filteredData.length < 2) return;
                
                const canvas = this.canvas;
                const ctx = this.ctx;
                
                // Show canvas
                canvas.style.display = 'block';
                document.querySelector('.map-placeholder').style.display = 'none';
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Calculate scale and offset
                const padding = 20;
                const width = canvas.width - 2 * padding;
                const height = canvas.height - 2 * padding;
                
                const latRange = this.mapBounds.maxLat - this.mapBounds.minLat;
                const lonRange = this.mapBounds.maxLon - this.mapBounds.minLon;
                
                const scale = Math.min(width / lonRange, height / latRange);
                
                // Draw track
                ctx.strokeStyle = '#2196f3';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                
                this.filteredData.forEach((point, index) => {
                    const x = padding + (point.longitude - this.mapBounds.minLon) * scale;
                    const y = padding + (this.mapBounds.maxLat - point.latitude) * scale;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // Draw start point
                if (this.filteredData.length > 0) {
                    const startPoint = this.filteredData[0];
                    const startX = padding + (startPoint.longitude - this.mapBounds.minLon) * scale;
                    const startY = padding + (this.mapBounds.maxLat - startPoint.latitude) * scale;
                    
                    ctx.fillStyle = '#4caf50';
                    ctx.beginPath();
                    ctx.arc(startX, startY, 6, 0, 2 * Math.PI);
                    ctx.fill();
                }
                
                                // Draw current point
                if (this.filteredData.length > 1) {
                    const currentPoint = this.filteredData[this.filteredData.length - 1];
                    const currentX = padding + (currentPoint.longitude - this.mapBounds.minLon) * scale;
                    const currentY = padding + (this.mapBounds.maxLat - currentPoint.latitude) * scale;
                    
                    ctx.fillStyle = '#f44336';
                    ctx.beginPath();
                    ctx.arc(currentX, currentY, 8, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Draw accuracy circle
                    if (currentPoint.accuracy) {
                        const accuracyRadius = (currentPoint.accuracy / 111000) * scale; // Convert meters to pixels
                        ctx.strokeStyle = 'rgba(244, 67, 54, 0.3)';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.arc(currentX, currentY, Math.max(accuracyRadius, 5), 0, 2 * Math.PI);
                        ctx.stroke();
                    }
                }
                
                // Draw scale indicator
                this.drawScaleIndicator(ctx, scale, padding);
            }
            
            drawScaleIndicator(ctx, scale, padding) {
                const scaleLength = 100; // pixels
                const scaleMeters = scaleLength / scale * 111000; // Convert to meters
                
                let displayLength, unit;
                if (scaleMeters >= 1000) {
                    displayLength = Math.round(scaleMeters / 1000);
                    unit = 'km';
                } else {
                    displayLength = Math.round(scaleMeters);
                    unit = 'm';
                }
                
                // Draw scale bar
                const x = padding;
                const y = this.canvas.height - padding - 20;
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + scaleLength, y);
                ctx.stroke();
                
                // Draw scale text
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${displayLength} ${unit}`, x + scaleLength / 2, y + 15);
            }
            
            updateCoordinatesDisplay(point) {
                const display = document.getElementById('coordinatesDisplay');
                if (!display) return;
                
                const lat = point.latitude.toFixed(8);
                const lon = point.longitude.toFixed(8);
                const alt = point.altitude ? point.altitude.toFixed(1) : '---.-';
                const acc = point.accuracy ? point.accuracy.toFixed(1) : '---.-';
                const spd = point.speed ? (point.speed * 3.6).toFixed(1) : '--.-';
                const hdg = point.heading ? Math.round(point.heading) : '---';
                
                const date = new Date(point.timestamp);
                const utc = date.toISOString().replace('T', ' ').substring(0, 19);
                
                display.innerHTML = `
                    LAT: ${lat}° LON: ${lon}°<br>
                    ALT: ${alt} m  ACC: ${acc} m<br>
                    SPD: ${spd} km/h  HDG: ${hdg}°<br>
                    UTC: ${utc}
                `;
            }
            
            updateAccuracyIndicator(accuracy) {
                const indicator = document.getElementById('accuracyIndicator');
                if (!indicator) return;
                
                let className, text;
                if (accuracy <= 5) {
                    className = 'accuracy-excellent';
                    text = `Excellent: ${accuracy.toFixed(1)}m`;
                } else if (accuracy <= 15) {
                    className = 'accuracy-good';
                    text = `Good: ${accuracy.toFixed(1)}m`;
                } else if (accuracy <= 50) {
                    className = 'accuracy-fair';
                    text = `Fair: ${accuracy.toFixed(1)}m`;
                } else {
                    className = 'accuracy-poor';
                    text = `Poor: ${accuracy.toFixed(1)}m`;
                }
                
                indicator.className = `accuracy-indicator ${className}`;
                indicator.textContent = `Accuracy: ${text}`;
            }
            
            updateStatisticsDisplay() {
                // Update point count
                const pointCount = document.getElementById('pointCount');
                if (pointCount) {
                    pointCount.textContent = `${this.filteredData.length} points`;
                }
                
                // Update distance
                const totalDistance = document.getElementById('totalDistance');
                if (totalDistance) {
                    totalDistance.textContent = `${this.totalDistance.toFixed(3)} km`;
                }
                
                // Update duration
                const duration = document.getElementById('duration');
                if (duration) {
                    duration.textContent = this.formatDuration(this.getCurrentDuration());
                }
                
                // Update speeds
                const avgSpeed = document.getElementById('avgSpeed');
                const maxSpeed = document.getElementById('maxSpeed');
                const currentDuration = this.getCurrentDuration();
                const avgSpeedValue = currentDuration > 0 ? (this.totalDistance / (currentDuration / 3600000)) : 0;
                
                if (avgSpeed) {
                    avgSpeed.textContent = `${avgSpeedValue.toFixed(2)} km/h`;
                }
                if (maxSpeed) {
                    maxSpeed.textContent = `${this.maxSpeed.toFixed(2)} km/h`;
                }
                
                // Update elevation
                const elevGain = document.getElementById('elevGain');
                if (elevGain) {
                    elevGain.textContent = `${Math.round(this.elevationGain)} m`;
                }
                
                // Update progress bars
                this.updateProgressBars();
                
                // Update quality metrics
                this.updateQualityMetrics();
            }
            
            updateProgressBars() {
                // Distance progress (10km goal)
                const distanceProgress = document.getElementById('distanceProgress');
                if (distanceProgress) {
                    const progress = Math.min((this.totalDistance / 10) * 100, 100);
                    distanceProgress.style.width = `${progress}%`;
                }
                
                // Speed progress (50km/h goal)
                const speedProgress = document.getElementById('speedProgress');
                if (speedProgress) {
                    const progress = Math.min((this.maxSpeed / 50) * 100, 100);
                    speedProgress.style.width = `${progress}%`;
                }
            }
            
            updateQualityMetrics() {
                // Calculate track precision
                let precision = 0;
                if (this.filteredData.length > 0) {
                    const avgAccuracy = this.filteredData.reduce((sum, point) => sum + (point.accuracy || 0), 0) / this.filteredData.length;
                    precision = Math.max(0, 100 - avgAccuracy);
                }
                
                // Calculate track smoothness
                let smoothness = 0;
                if (this.filteredData.length > 2) {
                    let totalAngleChange = 0;
                    for (let i = 2; i < this.filteredData.length; i++) {
                        const p1 = this.filteredData[i - 2];
                        const p2 = this.filteredData[i - 1];
                        const p3 = this.filteredData[i];
                        
                        const angle1 = Math.atan2(p2.latitude - p1.latitude, p2.longitude - p1.longitude);
                        const angle2 = Math.atan2(p3.latitude - p2.latitude, p3.longitude - p2.longitude);
                        const angleChange = Math.abs(angle2 - angle1);
                        totalAngleChange += angleChange;
                    }
                    smoothness = Math.max(0, 100 - (totalAngleChange * 180 / Math.PI / this.filteredData.length * 10));
                }
                
                // Update display
                const precisionElement = document.getElementById('trackPrecision');
                const smoothnessElement = document.getElementById('trackSmoothness');
                const fusionElement = document.getElementById('fusionStatus');
                
                if (precisionElement) precisionElement.textContent = `${Math.round(precision)}%`;
                if (smoothnessElement) smoothnessElement.textContent = `${Math.round(smoothness)}%`;
                if (fusionElement) {
                    const fusionEnabled = document.getElementById('sensorFusion')?.checked ?? false;
                    fusionElement.textContent = fusionEnabled ? 'Active' : 'Inactive';
                }
            }
            
            getCurrentDuration() {
                if (!this.startTime) return 0;
                
                let duration = Date.now() - this.startTime - this.pausedTime;
                
                // Subtract current pause time if paused
                if (this.isPaused && this.pauseStartTime) {
                    duration -= (Date.now() - this.pauseStartTime);
                }
                
                return Math.max(0, duration);
            }
            
            formatDuration(ms) {
                const seconds = Math.floor(ms / 1000) % 60;
                const minutes = Math.floor(ms / (1000 * 60)) % 60;
                const hours = Math.floor(ms / (1000 * 60 * 60));
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            updateTrackingUI() {
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const resumeBtn = document.getElementById('resumeBtn');
                const trackingStatus = document.getElementById('trackingStatus');
                
                if (this.isTracking) {
                    if (this.isPaused) {
                        // Paused state
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        pauseBtn.style.display = 'none';
                        resumeBtn.style.display = 'block';
                        resumeBtn.disabled = false;
                        trackingStatus.textContent = 'Paused';
                        trackingStatus.className = 'status inactive';
                    } else {
                        // Active tracking state
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        pauseBtn.style.display = 'block';
                        pauseBtn.disabled = false;
                        resumeBtn.style.display = 'none';
                        trackingStatus.textContent = 'Active';
                        trackingStatus.className = 'status active';
                    }
                } else {
                    // Stopped state
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    pauseBtn.disabled = true;
                    pauseBtn.style.display = 'block';
                    resumeBtn.style.display = 'none';
                    trackingStatus.textContent = 'Inactive';
                    trackingStatus.className = 'status inactive';
                }
            }
            
            enableExportButtons() {
                const hasData = this.filteredData.length > 0;
                const exportGpxBtn = document.getElementById('exportGpxBtn');
                const exportKmlBtn = document.getElementById('exportKmlBtn');
                const exportJsonBtn = document.getElementById('exportJsonBtn');
                
                if (exportGpxBtn) exportGpxBtn.disabled = !hasData;
                if (exportKmlBtn) exportKmlBtn.disabled = !hasData;
                if (exportJsonBtn) exportJsonBtn.disabled = !hasData;
            }
            
            handlePositionError(error) {
                let message = 'GPS error: ';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        message += 'Location access denied by user';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += 'Location information unavailable';
                        break;
                    case error.TIMEOUT:
                        message += 'Location request timed out';
                        break;
                    default:
                        message += 'Unknown error occurred';
                        break;
                }
                
                console.error(message, error);
                this.showError(message);
                
                // Update accuracy indicator
                const indicator = document.getElementById('accuracyIndicator');
                if (indicator) {
                    indicator.className = 'accuracy-indicator accuracy-poor';
                    indicator.textContent = 'GPS Error: ' + message;
                }
            }
            
            async requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Wake lock acquired');
                        
                        this.wakeLock.addEventListener('release', () => {
                            console.log('Wake lock released');
                        });
                    }
                } catch (error) {
                    console.warn('Wake lock failed:', error);
                }
            }
            
            releaseWakeLock() {
                if (this.wakeLock) {
                    this.wakeLock.release();
                    this.wakeLock = null;
                }
            }
            
            clearData() {
                if (this.isTracking) {
                    if (!confirm('Tracking is active. Stop tracking and clear all data?')) {
                        return;
                    }
                    this.stopTracking();
                } else if (this.filteredData.length > 0) {
                    if (!confirm('Clear all track data? This cannot be undone.')) {
                        return;
                    }
                }
                
                // Clear all data
                this.trackData = [];
                this.filteredData = [];
                this.sensorData = [];
                this.totalDistance = 0;
                this.maxSpeed = 0;
                this.elevationGain = 0;
                this.elevationLoss = 0;
                this.lastElevation = null;
                this.startTime = null;
                this.pausedTime = 0;
                this.pauseStartTime = null;
                
                // Reset map bounds
                this.mapBounds = {
                    minLat: 90, maxLat: -90,
                    minLon: 180, maxLon: -180
                };
                
                // Clear canvas
                if (this.ctx) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.canvas.style.display = 'none';
                    document.querySelector('.map-placeholder').style.display = 'flex';
                }
                
                // Reset displays
                this.updateStatisticsDisplay();
                this.updateTrackingUI();
                this.enableExportButtons();
                
                                // Reset coordinate display
                const coordDisplay = document.getElementById('coordinatesDisplay');
                if (coordDisplay) {
                    coordDisplay.innerHTML = `
                        LAT: -.--------° LON: -.--------°<br>
                        ALT: ---.- m  ACC: ---.- m<br>
                        SPD: --.- km/h  HDG: ---°<br>
                        UTC: ----/--/-- --:--:--
                    `;
                }
                
                // Reset accuracy indicator
                const accuracyIndicator = document.getElementById('accuracyIndicator');
                if (accuracyIndicator) {
                    accuracyIndicator.className = 'accuracy-indicator accuracy-poor';
                    accuracyIndicator.textContent = 'Accuracy: Initializing...';
                }
                
                console.log('All data cleared');
                this.showNotification('All data cleared', 'info');
            }
            
            startStatusUpdates() {
                setInterval(() => {
                    if (this.isTracking && !this.isPaused) {
                        this.updateStatisticsDisplay();
                    }
                }, 1000);
            }
            
            // Export Functions
            exportGPX() {
                if (this.filteredData.length === 0) {
                    this.showError('No track data to export');
                    return;
                }
                
                const gpxData = this.generateGPX();
                this.downloadFile(gpxData, 'track.gpx', 'application/gpx+xml');
                this.trackDataUsage(gpxData.length);
                this.showNotification('GPX file exported successfully', 'success');
            }
            
            exportKML() {
                if (this.filteredData.length === 0) {
                    this.showError('No track data to export');
                    return;
                }
                
                const kmlData = this.generateKML();
                this.downloadFile(kmlData, 'track.kml', 'application/vnd.google-earth.kml+xml');
                this.trackDataUsage(kmlData.length);
                this.showNotification('KML file exported successfully', 'success');
            }
            
            exportJSON() {
                if (this.filteredData.length === 0) {
                    this.showError('No track data to export');
                    return;
                }
                
                const jsonData = this.generateJSON();
                this.downloadFile(jsonData, 'track.json', 'application/json');
                this.trackDataUsage(jsonData.length);
                this.showNotification('JSON file exported successfully', 'success');
            }
            
            generateGPX() {
                const trackName = `GPS Track ${new Date().toISOString().split('T')[0]}`;
                const creator = 'Ultra GPS Tracker Pro';
                
                let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="${creator}" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>${trackName}</name>
    <time>${new Date().toISOString()}</time>
  </metadata>
  <trk>
    <name>${trackName}</name>
    <trkseg>`;
                
                this.filteredData.forEach(point => {
                    const time = new Date(point.timestamp).toISOString();
                    gpx += `
      <trkpt lat="${point.latitude}" lon="${point.longitude}">`;
                    
                    if (point.altitude !== null) {
                        gpx += `
        <ele>${point.altitude}</ele>`;
                    }
                    
                    gpx += `
        <time>${time}</time>`;
                    
                    if (point.accuracy !== null || point.speed !== null || point.heading !== null) {
                        gpx += `
        <extensions>`;
                        
                        if (point.accuracy !== null) {
                            gpx += `
          <accuracy>${point.accuracy}</accuracy>`;
                        }
                        
                        if (point.speed !== null) {
                            gpx += `
          <speed>${point.speed}</speed>`;
                        }
                        
                        if (point.heading !== null) {
                            gpx += `
          <course>${point.heading}</course>`;
                        }
                        
                        gpx += `
        </extensions>`;
                    }
                    
                    gpx += `
      </trkpt>`;
                });
                
                gpx += `
    </trkseg>
  </trk>
</gpx>`;
                
                return gpx;
            }
            
            generateKML() {
                const trackName = `GPS Track ${new Date().toISOString().split('T')[0]}`;
                
                let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${trackName}</name>
    <description>Generated by Ultra GPS Tracker Pro</description>
    
    <Style id="trackStyle">
      <LineStyle>
        <color>ff0000ff</color>
        <width>3</width>
      </LineStyle>
    </Style>
    
    <Placemark>
      <name>GPS Track</name>
      <styleUrl>#trackStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <coordinates>`;
                
                this.filteredData.forEach(point => {
                    const alt = point.altitude || 0;
                    kml += `${point.longitude},${point.latitude},${alt} `;
                });
                
                kml += `
        </coordinates>
      </LineString>
    </Placemark>
    
    <!-- Start Point -->
    <Placemark>
      <name>Start</name>
      <Point>
        <coordinates>${this.filteredData[0].longitude},${this.filteredData[0].latitude},${this.filteredData[0].altitude || 0}</coordinates>
      </Point>
    </Placemark>
    
    <!-- End Point -->
    <Placemark>
      <name>End</name>
      <Point>
        <coordinates>${this.filteredData[this.filteredData.length - 1].longitude},${this.filteredData[this.filteredData.length - 1].latitude},${this.filteredData[this.filteredData.length - 1].altitude || 0}</coordinates>
      </Point>
    </Placemark>
    
  </Document>
</kml>`;
                
                return kml;
            }
            
            generateJSON() {
                const trackData = {
                    metadata: {
                        name: `GPS Track ${new Date().toISOString().split('T')[0]}`,
                        creator: 'Ultra GPS Tracker Pro',
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        statistics: {
                            totalPoints: this.filteredData.length,
                            totalDistance: this.totalDistance,
                            duration: this.getCurrentDuration(),
                            maxSpeed: this.maxSpeed,
                            elevationGain: this.elevationGain,
                            elevationLoss: this.elevationLoss
                        }
                    },
                    track: this.filteredData,
                    rawData: this.trackData,
                    sensorData: this.sensorData
                };
                
                return JSON.stringify(trackData, null, 2);
            }
            
            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            // Settings Functions
            loadSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('gpsTrackerSettings') || '{}');
                    
                    // Apply GPS settings
                    if (settings.gpsInterval) {
                        const intervalSelect = document.getElementById('gpsInterval');
                        if (intervalSelect) intervalSelect.value = settings.gpsInterval;
                    }
                    
                    if (settings.highAccuracy !== undefined) {
                        const highAccuracyCheck = document.getElementById('highAccuracy');
                        if (highAccuracyCheck) highAccuracyCheck.checked = settings.highAccuracy;
                    }
                    
                    if (settings.positionTimeout) {
                        const timeoutInput = document.getElementById('positionTimeout');
                        if (timeoutInput) timeoutInput.value = settings.positionTimeout;
                    }
                    
                    if (settings.maximumAge) {
                        const maxAgeInput = document.getElementById('maximumAge');
                        if (maxAgeInput) maxAgeInput.value = settings.maximumAge;
                    }
                    
                    // Apply filtering settings
                    if (settings.sensorFusion !== undefined) {
                        const sensorFusionCheck = document.getElementById('sensorFusion');
                        if (sensorFusionCheck) sensorFusionCheck.checked = settings.sensorFusion;
                    }
                    
                    if (settings.trackSmoothing !== undefined) {
                        const smoothingCheck = document.getElementById('trackSmoothing');
                        if (smoothingCheck) smoothingCheck.checked = settings.trackSmoothing;
                    }
                    
                    if (settings.minAccuracy) {
                        const minAccuracyInput = document.getElementById('minAccuracy');
                        if (minAccuracyInput) minAccuracyInput.value = settings.minAccuracy;
                    }
                    
                    if (settings.minDistance) {
                        const minDistanceInput = document.getElementById('minDistance');
                        if (minDistanceInput) minDistanceInput.value = settings.minDistance;
                    }
                    
                    // Apply data usage settings
                    if (settings.dataSavingMode) {
                        const modeSelect = document.getElementById('dataSavingMode');
                        if (modeSelect) modeSelect.value = settings.dataSavingMode;
                        this.dataUsage.mode = settings.dataSavingMode;
                    }
                    
                    console.log('Settings loaded successfully');
                } catch (error) {
                    console.warn('Failed to load settings:', error);
                }
            }
            
            saveSettings() {
                try {
                    const settings = {
                        gpsInterval: document.getElementById('gpsInterval')?.value || '5000',
                        highAccuracy: document.getElementById('highAccuracy')?.checked ?? true,
                        positionTimeout: document.getElementById('positionTimeout')?.value || '15000',
                        maximumAge: document.getElementById('maximumAge')?.value || '10000',
                        sensorFusion: document.getElementById('sensorFusion')?.checked ?? true,
                        trackSmoothing: document.getElementById('trackSmoothing')?.checked ?? true,
                        minAccuracy: document.getElementById('minAccuracy')?.value || '50',
                        minDistance: document.getElementById('minDistance')?.value || '5',
                        dataSavingMode: document.getElementById('dataSavingMode')?.value || 'minimal',
                        enableMapTiles: document.getElementById('enableMapTiles')?.checked ?? false,
                        enableElevationAPI: document.getElementById('enableElevationAPI')?.checked ?? false,
                        enableCloudSync: document.getElementById('enableCloudSync')?.checked ?? false,
                        enableWeatherData: document.getElementById('enableWeatherData')?.checked ?? false,
                        deadReckoning: document.getElementById('deadReckoning')?.checked ?? false
                    };
                    
                    localStorage.setItem('gpsTrackerSettings', JSON.stringify(settings));
                    
                    // Apply data saving mode
                    this.dataUsage.mode = settings.dataSavingMode;
                    this.updateConnectionDisplay();
                    
                    console.log('Settings saved successfully');
                    this.showNotification('Settings saved successfully', 'success');
                    this.closeSettings();
                } catch (error) {
                    console.error('Failed to save settings:', error);
                    this.showError('Failed to save settings: ' + error.message);
                }
            }
            
            // Utility Functions
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    animation: slideIn 0.3s ease-out;
                `;
                
                switch (type) {
                    case 'success':
                        notification.style.backgroundColor = '#4caf50';
                        break;
                    case 'error':
                        notification.style.backgroundColor = '#f44336';
                        break;
                    case 'warning':
                        notification.style.backgroundColor = '#ff9800';
                        break;
                    default:
                        notification.style.backgroundColor = '#2196f3';
                }
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }, 3000);
            }
            
            showError(message) {
                this.showNotification(message, 'error');
                console.error(message);
            }
        }
        
        // Global instance
        let gpsTracker;
        
        // Global functions for UI
        function startTracking() {
            gpsTracker.startTracking();
        }
        
        function stopTracking() {
            gpsTracker.stopTracking();
        }
        
        function pauseTracking() {
            gpsTracker.pauseTracking();
        }
        
        function resumeTracking() {
            gpsTracker.resumeTracking();
        }
        
        function clearData() {
            gpsTracker.clearData();
        }
        
        function showSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function saveSettings() {
            gpsTracker.saveSettings();
        }
        
        function exportGPX() {
            gpsTracker.exportGPX();
        }
        
        function exportKML() {
            gpsTracker.exportKML();
        }
        
        function exportJSON() {
            gpsTracker.exportJSON();
        }
        
        function toggleCollapsible(element) {
            const content = element.nextElementSibling;
            const chevron = element.querySelector('.chevron');
            
            content.classList.toggle('active');
            chevron.classList.toggle('active');
        }
        
                // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            gpsTracker = new UltraGPSTracker();
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (gpsTracker && gpsTracker.canvas) {
                gpsTracker.setupCanvas();
                gpsTracker.drawTrack();
            }
        });
        
        // Handle visibility change (page hidden/visible)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('App hidden - maintaining GPS tracking');
            } else {
                console.log('App visible - resuming full functionality');
                if (gpsTracker) {
                    gpsTracker.updateStatisticsDisplay();
                }
            }
        });
        
        // Handle beforeunload (page closing)
        window.addEventListener('beforeunload', (event) => {
            if (gpsTracker && gpsTracker.isTracking) {
                event.preventDefault();
                event.returnValue = 'GPS tracking is active. Are you sure you want to leave?';
                return event.returnValue;
            }
        });
        
        // Touch/Swipe handling for mobile
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        
        document.addEventListener('touchstart', (event) => {
            touchStartX = event.changedTouches[0].screenX;
            touchStartY = event.changedTouches[0].screenY;
        });
        
        document.addEventListener('touchend', (event) => {
            touchEndX = event.changedTouches[0].screenX;
            touchEndY = event.changedTouches[0].screenY;
            handleSwipe();
        });
        
        function handleSwipe() {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const minSwipeDistance = 50;
            
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Horizontal swipe
                if (Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0) {
                        // Swipe right - start tracking
                        if (!gpsTracker.isTracking) {
                            startTracking();
                        } else if (gpsTracker.isPaused) {
                            resumeTracking();
                        }
                    } else {
                        // Swipe left - pause/stop tracking
                        if (gpsTracker.isTracking && !gpsTracker.isPaused) {
                            pauseTracking();
                        }
                    }
                }
            } else {
                // Vertical swipe
                if (Math.abs(deltaY) > minSwipeDistance) {
                    if (deltaY < 0) {
                        // Swipe up - show settings
                        showSettings();
                    } else {
                        // Swipe down - close modals
                        closeSettings();
                    }
                }
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT') {
                return; // Don't handle shortcuts when typing in inputs
            }
            
            switch (event.key.toLowerCase()) {
                case 's':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        showSettings();
                    } else {
                        if (!gpsTracker.isTracking) {
                            startTracking();
                        } else {
                            stopTracking();
                        }
                    }
                    break;
                case 'p':
                    if (gpsTracker.isTracking) {
                        if (gpsTracker.isPaused) {
                            resumeTracking();
                        } else {
                            pauseTracking();
                        }
                    }
                    break;
                case 'c':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        clearData();
                    }
                    break;
                case 'escape':
                    closeSettings();
                    break;
                case 'g':
                    if (gpsTracker.filteredData.length > 0) {
                        exportGPX();
                    }
                    break;
                case 'k':
                    if (gpsTracker.filteredData.length > 0) {
                        exportKML();
                    }
                    break;
                case 'j':
                    if (gpsTracker.filteredData.length > 0) {
                        exportJSON();
                    }
                    break;
            }
        });
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .swipe-hint {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 1000;
                animation: fadeIn 0.5s ease-out;
            }
            
            .btn:active {
                animation: pulse 0.2s ease-out;
            }
            
            .status.active {
                animation: pulse 2s infinite;
            }
            
            .accuracy-indicator {
                transition: all 0.3s ease;
            }
            
            .progress-bar {
                transition: width 0.5s ease;
            }
            
            .modal {
                animation: fadeIn 0.3s ease-out;
            }
            
            .modal-content {
                animation: slideIn 0.3s ease-out;
            }
            
            /* Responsive improvements */
            @media (max-width: 768px) {
                .controls {
                    flex-direction: column;
                    gap: 10px;
                }
                
                .btn-group {
                    flex-direction: column;
                    width: 100%;
                }
                
                .btn-group.triple {
                    flex-direction: row;
                }
                
                .stats-grid {
                    grid-template-columns: 1fr;
                    gap: 15px;
                }
                
                .modal-content {
                    margin: 10px;
                    max-height: 90vh;
                    overflow-y: auto;
                }
                
                .form-group {
                    margin-bottom: 20px;
                }
                
                .coordinates-display {
                    font-size: 12px;
                    padding: 10px;
                }
                
                .accuracy-indicator {
                    font-size: 12px;
                    padding: 8px;
                }
            }
            
            @media (max-width: 480px) {
                .container {
                    padding: 10px;
                }
                
                .header h1 {
                    font-size: 20px;
                }
                
                .btn {
                    padding: 10px 15px;
                    font-size: 14px;
                }
                
                .stat-card h3 {
                    font-size: 14px;
                }
                
                .stat-card .value {
                    font-size: 18px;
                }
                
                .map-container {
                    height: 250px;
                }
            }
            
            /* Dark mode support */
            @media (prefers-color-scheme: dark) {
                body {
                    background: #121212;
                    color: #ffffff;
                }
                
                .container {
                    background: #1e1e1e;
                }
                
                .stat-card {
                    background: #2d2d2d;
                    border-color: #404040;
                }
                
                .form-control {
                    background: #2d2d2d;
                    border-color: #404040;
                    color: #ffffff;
                }
                
                .modal-content {
                    background: #1e1e1e;
                    color: #ffffff;
                }
                
                .coordinates-display {
                    background: #2d2d2d;
                    border-color: #404040;
                }
                
                .map-placeholder {
                    background: #2d2d2d;
                    border-color: #404040;
                    color: #888;
                }
            }
            
            /* Print styles */
            @media print {
                .controls, .modal, .notification {
                    display: none !important;
                }
                
                .container {
                    box-shadow: none;
                    border: 1px solid #ccc;
                }
                
                .map-container {
                    border: 2px solid #000;
                }
                
                .stats-grid {
                    page-break-inside: avoid;
                }
            }
            
            /* High contrast mode */
            @media (prefers-contrast: high) {
                .btn {
                    border: 2px solid;
                }
                
                .stat-card {
                    border: 2px solid;
                }
                
                .accuracy-indicator {
                    border: 2px solid;
                }
            }
            
            /* Reduced motion */
            @media (prefers-reduced-motion: reduce) {
                * {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Service Worker registration for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // Add manifest for PWA
        const manifest = {
            name: "Ultra GPS Tracker Pro",
            short_name: "GPS Tracker",
            description: "Professional GPS tracking with advanced features",
            start_url: "/",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#2196f3",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%232196f3'/%3E%3Cpath d='M50 20 L60 40 L50 35 L40 40 Z' fill='white'/%3E%3C/svg%3E",
                    sizes: "192x192",
                    type: "image/svg+xml"
                }
            ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = manifestURL;
        document.head.appendChild(manifestLink);
        
        console.log('Ultra GPS Tracker Pro loaded successfully');
        console.log('Keyboard shortcuts:');
        console.log('S - Start/Stop tracking');
        console.log('P - Pause/Resume tracking');
        console.log('Ctrl+S - Settings');
        console.log('Ctrl+C - Clear data');
        console.log('G - Export GPX');
        console.log('K - Export KML');
        console.log('J - Export JSON');
        console.log('ESC - Close modals');
    </script>
</body>
</html>






