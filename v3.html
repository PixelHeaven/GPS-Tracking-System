<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra GPS Tracker Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #2196f3, #21cbf3);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-group.triple {
            gap: 5px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover:before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(244, 67, 54, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 152, 0, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #607d8b, #455a64);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(96, 125, 139, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #2196f3;
        }
        
        .status-card h3 {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status {
            font-size: 16px;
            font-weight: 700;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .status.active {
            background: #4caf50;
            color: white;
        }
        
        .status.inactive {
            background: #f44336;
            color: white;
        }
        
        .status.online {
            background: #4caf50;
            color: white;
        }
        
        .status.offline {
            background: #f44336;
            color: white;
        }
        
        .status.wifi {
            background: #2196f3;
            color: white;
        }
        
        .status.cellular {
            background: #ff9800;
            color: white;
        }
        
        .status.ethernet {
            background: #9c27b0;
            color: white;
        }
        
        .coordinates-display {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
            border: 2px solid #333;
        }
        
        .gps-status {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .gps-indicator {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .gps-warming {
            background: #ff9800;
            color: white;
        }
        
        .gps-acquiring {
            background: #2196f3;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .gps-locked {
            background: #4caf50;
            color: white;
        }
        
        .gps-lost {
            background: #f44336;
            color: white;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .accuracy-indicator {
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .accuracy-excellent {
            background: #4caf50;
            color: white;
        }
        
        .accuracy-good {
            background: #8bc34a;
            color: white;
        }
        
        .accuracy-fair {
            background: #ff9800;
            color: white;
        }
        
        .accuracy-poor {
            background: #f44336;
            color: white;
        }
        
        .map-container {
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 15px;
            height: 400px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .map-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            font-size: 18px;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
        }
        
        #trackCanvas {
            display: none;
            width: 100%;
            height: 100%;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 20px;
            font-weight: 700;
            color: #2196f3;
            margin-bottom: 10px;
        }
        
        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #2196f3, #21cbf3);
            color: white;
            padding: 20px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .settings-section {
            margin-bottom: 25px;
        }
        
        .collapsible {
            background: #f8f9fa;
            border: none;
            padding: 15px 20px;
            width: 100%;
            text-align: left;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }
        
        .collapsible:hover {
            background: #e9ecef;
        }
        
        .chevron {
            transition: transform 0.3s;
        }
        
        .chevron.active {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .collapsible-content.active {
            max-height: 800px;
            border: 1px solid #e0e0e0;
        }
        
        .collapsible-inner {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
                .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .connection-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .info-item .label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .info-item .value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .network-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .network-indicator {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .network-indicator.active {
            background: #4caf50;
            color: white;
        }
        
        .network-indicator.inactive {
            background: #f5f5f5;
            color: #666;
        }
        
        .data-usage-chart {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .usage-bar {
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .usage-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .wifi-usage {
            background: linear-gradient(90deg, #2196f3, #1976d2);
        }
        
        .cellular-usage {
            background: linear-gradient(90deg, #ff9800, #f57c00);
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .warning-box .warning-icon {
            color: #f39c12;
            font-size: 18px;
            margin-right: 10px;
        }
        
        .warning-box .warning-text {
            color: #8e6a00;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-group {
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }
            
            .modal-header {
                padding: 15px 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-footer {
                padding: 15px 20px;
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛰️ Ultra GPS Tracker Pro</h1>
            <div class="subtitle">Professional GPS Tracking with Advanced Analytics</div>
        </div>
        
        <div class="main-content">
            <!-- Control Buttons -->
            <div class="controls">
                <div class="btn-group">
                    <button id="startBtn" class="btn btn-primary" onclick="startTracking()">🚀 Start Tracking</button>
                    <button id="stopBtn" class="btn btn-danger" onclick="stopTracking()" disabled>⏹️ Stop</button>
                </div>
                
                <div class="btn-group">
                    <button id="pauseBtn" class="btn btn-warning" onclick="pauseTracking()" disabled>⏸️ Pause</button>
                    <button id="resumeBtn" class="btn btn-primary" onclick="resumeTracking()" style="display: none;">▶️ Resume</button>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="showSettings()">⚙️ Settings</button>
                    <button class="btn btn-danger" onclick="clearData()">🗑️ Clear</button>
                </div>
                
                <div class="btn-group triple">
                    <button id="exportGpxBtn" class="btn btn-secondary" onclick="exportGPX()" disabled>📄 GPX</button>
                    <button id="exportKmlBtn" class="btn btn-secondary" onclick="exportKML()" disabled>🗺️ KML</button>
                    <button id="exportJsonBtn" class="btn btn-secondary" onclick="exportJSON()" disabled>📊 JSON</button>
                </div>
            </div>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-card">
                    <h3>GPS Status</h3>
                    <div id="trackingStatus" class="status inactive">Inactive</div>
                </div>
                
                <div class="status-card">
                    <h3>Connection</h3>
                    <div id="connectionStatus" class="status offline">Offline</div>
                </div>
                
                <div class="status-card">
                    <h3>Network Type</h3>
                    <div id="networkType" class="status">Unknown</div>
                </div>
                
                <div class="status-card">
                    <h3>WiFi Data</h3>
                    <div id="wifiUsage" class="status">0 KB</div>
                </div>
                
                <div class="status-card">
                    <h3>Cellular Data</h3>
                    <div id="cellularUsage" class="status">0 KB</div>
                </div>
            </div>
            
            <!-- GPS Status Indicators -->
            <div class="gps-status">
                <div id="gpsStatusIndicator" class="gps-indicator gps-warming">GPS Warming</div>
                <div id="satelliteCount" class="gps-indicator" style="background: #607d8b; color: white;">Satellites: 0</div>
                <div id="gpsSpeed" class="gps-indicator" style="background: #9c27b0; color: white;">Update: 0s</div>
            </div>
            
            <!-- GPS Coordinates Display -->
            <div id="coordinatesDisplay" class="coordinates-display">
                LAT: -.--------° LON: -.--------°<br>
                ALT: ---.- m  ACC: ---.- m<br>
                SPD: --.- km/h  HDG: ---°<br>
                UTC: ----/--/-- --:--:--<br>
                HDOP: --.-- VDOP: --.--
            </div>
            
            <!-- Accuracy Indicator -->
            <div id="accuracyIndicator" class="accuracy-indicator accuracy-poor">
                Accuracy: Initializing GPS...
            </div>
            
            <!-- Map Container -->
            <div class="map-container">
                <div id="mapPlaceholder" class="map-placeholder">
                    📍 GPS track will appear here when tracking starts
                </div>
                <canvas id="trackCanvas"></canvas>
            </div>
            
            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>📊 Track Points</h3>
                    <div id="pointCount" class="value">0 points</div>
                    <div class="progress-container">
                        <div id="pointProgress" class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>📏 Total Distance</h3>
                    <div id="totalDistance" class="value">0.000 km</div>
                    <div class="progress-container">
                        <div id="distanceProgress" class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>⏱️ Duration</h3>
                    <div id="duration" class="value">00:00:00</div>
                </div>
                
                <div class="stat-card">
                    <h3>🚗 Average Speed</h3>
                    <div id="avgSpeed" class="value">0.00 km/h</div>
                </div>
                
                <div class="stat-card">
                    <h3>⚡ Max Speed</h3>
                    <div id="maxSpeed" class="value">0.00 km/h</div>
                    <div class="progress-container">
                        <div id="speedProgress" class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>⛰️ Elevation Gain</h3>
                    <div id="elevGain" class="value">0 m</div>
                </div>
                
                <div class="stat-card">
                    <h3>🎯 GPS Precision</h3>
                    <div id="trackPrecision" class="value">0%</div>
                </div>
                
                <div class="stat-card">
                    <h3>📡 Signal Quality</h3>
                    <div id="signalQuality" class="value">Poor</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Advanced Settings</h2>
                <button class="close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- GPS Settings -->
                <div class="settings-section">
                    <button class="collapsible" onclick="toggleCollapsible(this)">
                        🛰️ GPS Configuration
                        <span class="chevron">▼</span>
                    </button>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <div class="form-group">
                                <label for="gpsInterval">Update Interval (ms)</label>
                                <select id="gpsInterval" class="form-control">
                                    <option value="500">0.5 seconds (Ultra high)</option>
                                    <option value="1000" selected>1 second (High precision)</option>
                                    <option value="2000">2 seconds (Balanced)</option>
                                    <option value="5000">5 seconds (Battery saver)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="highAccuracy" checked>
                                    <label for="highAccuracy">Enable High Accuracy GPS</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="gpsWarming" checked>
                                    <label for="gpsWarming">GPS Warming (Faster Initial Fix)</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="multipleRequests" checked>
                                    <label for="multipleRequests">Multiple Position Requests</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="positionTimeout">Position Timeout (ms)</label>
                                <input type="number" id="positionTimeout" class="form-control" value="10000" min="3000" max="30000">
                            </div>
                            
                            <div class="form-group">
                                <label for="maximumAge">Maximum Age (ms)</label>
                                <input type="number" id="maximumAge" class="form-control" value="5000" min="0" max="60000">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Network Settings -->
                <div class="settings-section">
                    <button class="collapsible" onclick="toggleCollapsible(this)">
                        📡 Network & Data Control
                        <span class="chevron">▼</span>
                    </button>
                                        <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <div class="network-status">
                                <div id="wifiIndicator" class="network-indicator inactive">📶 WiFi</div>
                                <div id="cellularIndicator" class="network-indicator inactive">📱 Cellular</div>
                                <div id="ethernetIndicator" class="network-indicator inactive">🔌 Ethernet</div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="allowWifi" checked>
                                    <label for="allowWifi">Allow WiFi Data Usage</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="allowCellular" checked>
                                    <label for="allowCellular">Allow Cellular Data Usage</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="wifiOnlyMode">
                                    <label for="wifiOnlyMode">WiFi Only Mode (Disable Cellular)</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="cellularDataLimit">Cellular Data Limit (MB)</label>
                                <input type="number" id="cellularDataLimit" class="form-control" value="50" min="1" max="1000">
                            </div>
                            
                            <div class="warning-box">
                                <span class="warning-icon">⚠️</span>
                                <span class="warning-text">Disabling network features may affect GPS accuracy and cloud sync</span>
                            </div>
                            
                            <div class="data-usage-chart">
                                <h4 style="margin-bottom: 15px;">Data Usage This Session</h4>
                                <div style="margin-bottom: 10px;">
                                    <small>WiFi Usage</small>
                                    <div class="usage-bar">
                                        <div id="wifiUsageBar" class="usage-fill wifi-usage" style="width: 0%"></div>
                                    </div>
                                    <span id="wifiUsageText">0 KB</span>
                                </div>
                                <div>
                                    <small>Cellular Usage</small>
                                    <div class="usage-bar">
                                        <div id="cellularUsageBar" class="usage-fill cellular-usage" style="width: 0%"></div>
                                    </div>
                                    <span id="cellularUsageText">0 KB</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtering Settings -->
                <div class="settings-section">
                    <button class="collapsible" onclick="toggleCollapsible(this)">
                        🔧 Data Filtering & Accuracy
                        <span class="chevron">▼</span>
                    </button>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="sensorFusion" checked>
                                    <label for="sensorFusion">Enable Sensor Fusion</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="trackSmoothing" checked>
                                    <label for="trackSmoothing">Enable Track Smoothing</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="kalmanFiltering" checked>
                                    <label for="kalmanFiltering">Advanced Kalman Filtering</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="minAccuracy">Minimum Accuracy (meters)</label>
                                <input type="number" id="minAccuracy" class="form-control" value="20" min="1" max="200">
                            </div>
                            
                            <div class="form-group">
                                <label for="minDistance">Minimum Distance (meters)</label>
                                <input type="number" id="minDistance" class="form-control" value="2" min="0" max="50">
                            </div>
                            
                            <div class="form-group">
                                <label for="maxSpeedFilter">Maximum Speed Filter (km/h)</label>
                                <input type="number" id="maxSpeedFilter" class="form-control" value="200" min="10" max="500">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Management -->
                <div class="settings-section">
                    <button class="collapsible" onclick="toggleCollapsible(this)">
                        💾 Data Management
                        <span class="chevron">▼</span>
                    </button>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <div class="form-group">
                                <label for="dataSavingMode">Data Saving Mode</label>
                                <select id="dataSavingMode" class="form-control">
                                    <option value="offline" selected>Offline Only (No Data Usage)</option>
                                    <option value="wifi">WiFi Only</option>
                                    <option value="minimal">Minimal Data</option>
                                    <option value="balanced">Balanced</option>
                                    <option value="full">Full Features</option>
                                </select>
                            </div>
                            
                            <div class="connection-info">
                                <div class="info-item">
                                    <div class="label">Storage Used</div>
                                    <div id="storageUsed" class="value">0 KB</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">Points Stored</div>
                                    <div id="pointsStored" class="value">0</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">Session Time</div>
                                    <div id="sessionTime" class="value">00:00</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">WiFi Data</div>
                                    <div id="sessionWifiData" class="value">0 KB</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">Cellular Data</div>
                                    <div id="sessionCellularData" class="value">0 KB</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Features -->
                <div class="settings-section">
                    <button class="collapsible" onclick="toggleCollapsible(this)">
                        🚀 Advanced Features
                        <span class="chevron">▼</span>
                    </button>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="deadReckoning" checked>
                                    <label for="deadReckoning">Dead Reckoning (GPS Loss Recovery)</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="predictiveTracking">
                                    <label for="predictiveTracking">Predictive Position Tracking</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="enableMapTiles">
                                    <label for="enableMapTiles">Enable Map Tiles (Uses Data)</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="enableElevationAPI">
                                    <label for="enableElevationAPI">Enhanced Elevation Data (Uses Data)</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="enableCloudSync">
                                    <label for="enableCloudSync">Cloud Synchronization (Uses Data)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetSettings()">Reset to Default</button>
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
    
    <script>
        class UltraGPSTracker {
            constructor() {
                this.isTracking = false;
                this.isPaused = false;
                this.watchId = null;
                this.warmupWatchId = null;
                this.trackData = [];
                this.filteredData = [];
                this.totalDistance = 0;
                this.maxSpeed = 0;
                this.elevationGain = 0;
                this.elevationLoss = 0;
                this.lastElevation = null;
                this.startTime = null;
                this.pausedTime = 0;
                this.pauseStartTime = null;
                this.wakeLock = null;
                this.lastPositionTime = 0;
                this.gpsStatus = 'warming';
                this.satelliteCount = 0;
                
                // Enhanced GPS tracking
                this.gpsWarming = false;
                this.multipleRequests = [];
                this.lastGoodPosition = null;
                this.positionHistory = [];
                this.deadReckoningActive = false;
                
                // Network tracking
                this.networkConnection = null;
                this.connectionType = 'unknown';
                this.dataUsage = {
                    wifi: { session: 0, total: 0 },
                    cellular: { session: 0, total: 0 },
                    total: { session: 0, total: 0 },
                    mode: 'offline'
                };
                
                // Network controls
                this.networkSettings = {
                    allowWifi: true,
                    allowCellular: true,
                    wifiOnlyMode: false,
                    cellularDataLimit: 50 * 1024 * 1024, // 50MB in bytes
                    dataSavingMode: 'offline'
                };
                
                // Kalman filter variables
                this.kalmanFilter = {
                    lat: { x: 0, p: 1000, q: 0.001, r: 0.5 },
                    lon: { x: 0, p: 1000, q: 0.001, r: 0.5 },
                    speed: { x: 0, p: 100, q: 0.1, r: 1 }
                };
                
                // Sensor fusion data
                this.deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
                this.deviceMotion = { x: 0, y: 0, z: 0 };
                this.compassCalibrated = false;
                
                // Canvas for track visualization
                this.canvas = null;
                this.ctx = null;
                this.trackBounds = { minLat: null, maxLat: null, minLon: null, maxLon: null };
                
                this.init();
            }
            
            init() {
                console.log('Initializing Ultra GPS Tracker Pro...');
                this.setupCanvas();
                this.setupSensors();
                this.setupNetworkMonitoring();
                this.loadSettings();
                this.updateConnectionDisplay();
                this.startStatusUpdates();
                this.requestPermissions();
                
                // Start GPS warming if enabled
                if (this.getSetting('gpsWarming', true)) {
                    this.startGPSWarming();
                }
                
                console.log('Ultra GPS Tracker Pro initialized successfully');
            }
            
            async requestPermissions() {
                try {
                    if ('geolocation' in navigator) {
                        console.log('Geolocation API available');
                    } else {
                        throw new Error('Geolocation not supported');
                    }
                    
                    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission !== 'granted') {
                            console.warn('Device orientation permission denied');
                        }
                    }
                    
                    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission !== 'granted') {
                            console.warn('Device motion permission denied');
                        }
                    }
                    
                    if ('wakeLock' in navigator) {
                        console.log('Wake Lock API available');
                    }
                    
                } catch (error) {
                    console.warn('Permission request failed:', error);
                }
            }
            
            setupNetworkMonitoring() {
                // Monitor network connection
                this.updateNetworkStatus();
                
                // Network Information API
                if ('connection' in navigator) {
                    this.networkConnection = navigator.connection;
                    this.connectionType = this.networkConnection.effectiveType || 'unknown';
                    
                    this.networkConnection.addEventListener('change', () => {
                        this.updateNetworkStatus();
                    });
                }
                
                // Online/offline events
                window.addEventListener('online', () => {
                    this.updateNetworkStatus();
                    this.showNotification('Connection restored', 'success');
                });
                
                window.addEventListener('offline', () => {
                    this.updateNetworkStatus();
                    this.showNotification('Working offline', 'warning');
                });
            }
            
            updateNetworkStatus() {
                const isOnline = navigator.onLine;
                let connectionType = 'unknown';
                let effectiveType = 'unknown';
                
                if (this.networkConnection) {
                    connectionType = this.networkConnection.type || 'unknown';
                                        effectiveType = this.networkConnection.effectiveType || 'unknown';
                    
                    // Update UI indicators
                    this.updateNetworkIndicators(connectionType, isOnline);
                }
                
                this.connectionType = connectionType;
                
                // Update connection display
                const connectionStatus = document.getElementById('connectionStatus');
                const networkType = document.getElementById('networkType');
                
                if (connectionStatus) {
                    connectionStatus.textContent = isOnline ? 'Online' : 'Offline';
                    connectionStatus.className = `status ${isOnline ? 'online' : 'offline'}`;
                }
                
                if (networkType) {
                    let displayType = 'Unknown';
                    let statusClass = 'status';
                    
                    if (isOnline) {
                        switch (connectionType) {
                            case 'wifi':
                                displayType = 'WiFi';
                                statusClass += ' wifi';
                                break;
                            case 'cellular':
                                displayType = `Cellular (${effectiveType})`;
                                statusClass += ' cellular';
                                break;
                            case 'ethernet':
                                displayType = 'Ethernet';
                                statusClass += ' ethernet';
                                break;
                            default:
                                displayType = isOnline ? 'Online' : 'Offline';
                                statusClass += isOnline ? ' online' : ' offline';
                        }
                    } else {
                        displayType = 'Offline';
                        statusClass += ' offline';
                    }
                    
                    networkType.textContent = displayType;
                    networkType.className = statusClass;
                }
                
                console.log(`Network: ${isOnline ? 'Online' : 'Offline'}, Type: ${connectionType}, Speed: ${effectiveType}`);
            }
            
            updateNetworkIndicators(connectionType, isOnline) {
                const wifiIndicator = document.getElementById('wifiIndicator');
                const cellularIndicator = document.getElementById('cellularIndicator');
                const ethernetIndicator = document.getElementById('ethernetIndicator');
                
                // Reset all indicators
                [wifiIndicator, cellularIndicator, ethernetIndicator].forEach(indicator => {
                    if (indicator) {
                        indicator.className = 'network-indicator inactive';
                    }
                });
                
                // Set active indicator
                if (isOnline) {
                    switch (connectionType) {
                        case 'wifi':
                            if (wifiIndicator) wifiIndicator.className = 'network-indicator active';
                            break;
                        case 'cellular':
                            if (cellularIndicator) cellularIndicator.className = 'network-indicator active';
                            break;
                        case 'ethernet':
                            if (ethernetIndicator) ethernetIndicator.className = 'network-indicator active';
                            break;
                    }
                }
            }
            
            trackDataUsage(bytes, forceType = null) {
                const connectionType = forceType || this.connectionType;
                
                // Check if data usage is allowed
                if (!this.isDataUsageAllowed(connectionType, bytes)) {
                    console.warn(`Data usage blocked for ${connectionType}: ${bytes} bytes`);
                    return false;
                }
                
                // Track usage by connection type
                if (connectionType === 'wifi' && this.networkSettings.allowWifi) {
                    this.dataUsage.wifi.session += bytes;
                    this.dataUsage.wifi.total += bytes;
                } else if (connectionType === 'cellular' && this.networkSettings.allowCellular) {
                    this.dataUsage.cellular.session += bytes;
                    this.dataUsage.cellular.total += bytes;
                    
                    // Check cellular data limit
                    if (this.dataUsage.cellular.total > this.networkSettings.cellularDataLimit) {
                        this.showNotification('Cellular data limit exceeded!', 'warning');
                        this.networkSettings.allowCellular = false;
                        return false;
                    }
                }
                
                this.dataUsage.total.session += bytes;
                this.dataUsage.total.total += bytes;
                
                this.updateDataUsageDisplay();
                return true;
            }
            
            isDataUsageAllowed(connectionType, bytes) {
                // Check WiFi-only mode
                if (this.networkSettings.wifiOnlyMode && connectionType !== 'wifi') {
                    return false;
                }
                
                // Check connection type permissions
                if (connectionType === 'wifi' && !this.networkSettings.allowWifi) {
                    return false;
                }
                
                if (connectionType === 'cellular' && !this.networkSettings.allowCellular) {
                    return false;
                }
                
                // Check cellular data limit
                if (connectionType === 'cellular') {
                    if (this.dataUsage.cellular.total + bytes > this.networkSettings.cellularDataLimit) {
                        return false;
                    }
                }
                
                // Check offline mode
                if (this.networkSettings.dataSavingMode === 'offline') {
                    return false;
                }
                
                return true;
            }
            
            updateDataUsageDisplay() {
                // Update status cards
                const wifiUsage = document.getElementById('wifiUsage');
                const cellularUsage = document.getElementById('cellularUsage');
                
                if (wifiUsage) {
                    wifiUsage.textContent = this.formatDataUsage(this.dataUsage.wifi.session);
                }
                
                if (cellularUsage) {
                    cellularUsage.textContent = this.formatDataUsage(this.dataUsage.cellular.session);
                }
                
                // Update usage bars in settings
                const wifiUsageBar = document.getElementById('wifiUsageBar');
                const cellularUsageBar = document.getElementById('cellularUsageBar');
                const wifiUsageText = document.getElementById('wifiUsageText');
                const cellularUsageText = document.getElementById('cellularUsageText');
                
                if (wifiUsageBar && wifiUsageText) {
                    const wifiPercent = Math.min(100, (this.dataUsage.wifi.session / (10 * 1024 * 1024)) * 100); // Scale to 10MB
                    wifiUsageBar.style.width = `${wifiPercent}%`;
                    wifiUsageText.textContent = this.formatDataUsage(this.dataUsage.wifi.session);
                }
                
                if (cellularUsageBar && cellularUsageText) {
                    const cellularPercent = Math.min(100, (this.dataUsage.cellular.session / this.networkSettings.cellularDataLimit) * 100);
                    cellularUsageBar.style.width = `${cellularPercent}%`;
                    cellularUsageText.textContent = this.formatDataUsage(this.dataUsage.cellular.session);
                }
            }
            
            formatDataUsage(bytes) {
                if (bytes < 1024) return `${bytes} B`;
                if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
                return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
            }
            
            startGPSWarming() {
                if (this.gpsWarming) return;
                
                console.log('Starting GPS warming...');
                this.gpsWarming = true;
                this.updateGPSStatus('warming');
                
                // Start a low-power position watch to warm up GPS
                const warmupOptions = {
                    enableHighAccuracy: false,
                    timeout: 30000,
                    maximumAge: 60000
                };
                
                this.warmupWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        console.log('GPS warmed up successfully');
                        this.lastGoodPosition = position;
                        this.updateGPSStatus('ready');
                        this.stopGPSWarming();
                    },
                    (error) => {
                        console.warn('GPS warming error:', error);
                    },
                    warmupOptions
                );
                
                // Stop warming after 2 minutes
                setTimeout(() => {
                    this.stopGPSWarming();
                }, 120000);
            }
            
            stopGPSWarming() {
                if (this.warmupWatchId) {
                    navigator.geolocation.clearWatch(this.warmupWatchId);
                    this.warmupWatchId = null;
                }
                this.gpsWarming = false;
            }
            
            updateGPSStatus(status) {
                this.gpsStatus = status;
                const indicator = document.getElementById('gpsStatusIndicator');
                
                if (indicator) {
                    switch (status) {
                        case 'warming':
                            indicator.className = 'gps-indicator gps-warming';
                            indicator.textContent = 'GPS Warming';
                            break;
                        case 'acquiring':
                            indicator.className = 'gps-indicator gps-acquiring';
                            indicator.textContent = 'Acquiring GPS';
                            break;
                        case 'locked':
                            indicator.className = 'gps-indicator gps-locked';
                            indicator.textContent = 'GPS Locked';
                            break;
                        case 'ready':
                            indicator.className = 'gps-indicator gps-locked';
                            indicator.textContent = 'GPS Ready';
                            break;
                        case 'lost':
                            indicator.className = 'gps-indicator gps-lost';
                            indicator.textContent = 'GPS Lost';
                            break;
                    }
                }
            }
            
            setupCanvas() {
                this.canvas = document.getElementById('trackCanvas');
                if (this.canvas) {
                    this.ctx = this.canvas.getContext('2d');
                    const container = this.canvas.parentElement;
                    this.canvas.width = container.clientWidth;
                    this.canvas.height = container.clientHeight;
                }
            }
            
            setupSensors() {
                                // Device orientation (compass)
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', (event) => {
                        this.deviceOrientation = {
                            alpha: event.alpha || 0,  // Compass heading
                            beta: event.beta || 0,    // Front-to-back tilt
                            gamma: event.gamma || 0   // Left-to-right tilt
                        };
                        this.compassCalibrated = event.absolute || false;
                    });
                }
                
                // Device motion (accelerometer)
                if (window.DeviceMotionEvent) {
                    window.addEventListener('devicemotion', (event) => {
                        const acc = event.accelerationIncludingGravity;
                        if (acc) {
                            this.deviceMotion = {
                                x: acc.x || 0,
                                y: acc.y || 0,
                                z: acc.z || 0
                            };
                        }
                    });
                }
            }
            
            async startTracking() {
                if (this.isTracking) return;
                
                try {
                    // Request wake lock to prevent screen from turning off
                    if ('wakeLock' in navigator) {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Wake lock acquired');
                    }
                    
                    // Stop GPS warming
                    this.stopGPSWarming();
                    
                    // Clear any existing multiple requests
                    this.clearMultipleRequests();
                    
                    const options = {
                        enableHighAccuracy: this.getSetting('highAccuracy', true),
                        timeout: parseInt(this.getSetting('positionTimeout', '10000')),
                        maximumAge: parseInt(this.getSetting('maximumAge', '5000'))
                    };
                    
                    this.updateGPSStatus('acquiring');
                    
                    // Start primary position watch
                    this.watchId = navigator.geolocation.watchPosition(
                        (position) => this.onPositionUpdate(position),
                        (error) => this.onPositionError(error),
                        options
                    );
                    
                    // Start multiple requests if enabled
                    if (this.getSetting('multipleRequests', true)) {
                        this.startMultipleRequests();
                    }
                    
                    this.isTracking = true;
                    this.isPaused = false;
                    this.startTime = Date.now();
                    this.pausedTime = 0;
                    this.lastPositionTime = 0;
                    
                    this.updateUI();
                    this.updateNetworkStatus();
                    
                    console.log('GPS tracking started with enhanced settings');
                    this.showNotification('GPS tracking started', 'success');
                    
                } catch (error) {
                    console.error('Failed to start tracking:', error);
                    this.showError('Failed to start tracking: ' + error.message);
                }
            }
            
            startMultipleRequests() {
                const interval = parseInt(this.getSetting('gpsInterval', '1000'));
                
                // Create multiple position requests with different timeouts
                const requestConfigs = [
                    { timeout: 5000, maximumAge: 1000 },
                    { timeout: 8000, maximumAge: 3000 },
                    { timeout: 12000, maximumAge: 5000 }
                ];
                
                requestConfigs.forEach((config, index) => {
                    const requestInterval = setInterval(() => {
                        if (!this.isTracking || this.isPaused) {
                            clearInterval(requestInterval);
                            return;
                        }
                        
                        const options = {
                            enableHighAccuracy: true,
                            timeout: config.timeout,
                            maximumAge: config.maximumAge
                        };
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => this.onPositionUpdate(position, `request-${index}`),
                            (error) => console.warn(`Multiple request ${index} failed:`, error),
                            options
                        );
                    }, interval + (index * 200)); // Stagger requests
                    
                    this.multipleRequests.push(requestInterval);
                });
            }
            
            clearMultipleRequests() {
                this.multipleRequests.forEach(interval => clearInterval(interval));
                this.multipleRequests = [];
            }
            
            stopTracking() {
                if (!this.isTracking) return;
                
                if (this.watchId !== null) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
                
                this.clearMultipleRequests();
                
                // Release wake lock
                if (this.wakeLock) {
                    this.wakeLock.release();
                    this.wakeLock = null;
                    console.log('Wake lock released');
                }
                
                this.isTracking = false;
                this.isPaused = false;
                this.deadReckoningActive = false;
                
                this.updateGPSStatus('ready');
                this.updateUI();
                this.updateNetworkStatus();
                
                console.log('GPS tracking stopped');
                this.showNotification('GPS tracking stopped', 'info');
            }
            
            pauseTracking() {
                if (!this.isTracking || this.isPaused) return;
                
                this.isPaused = true;
                this.pauseStartTime = Date.now();
                
                this.updateUI();
                console.log('GPS tracking paused');
                this.showNotification('GPS tracking paused', 'warning');
            }
            
            resumeTracking() {
                if (!this.isTracking || !this.isPaused) return;
                
                this.isPaused = false;
                if (this.pauseStartTime) {
                    this.pausedTime += Date.now() - this.pauseStartTime;
                    this.pauseStartTime = null;
                }
                
                this.updateUI();
                console.log('GPS tracking resumed');
                this.showNotification('GPS tracking resumed', 'success');
            }
            
            onPositionUpdate(position, source = 'primary') {
                if (!this.isTracking || this.isPaused) return;
                
                const now = Date.now();
                const coords = position.coords;
                const timestamp = position.timestamp;
                
                // Update GPS status
                this.updateGPSStatus('locked');
                this.lastPositionTime = now;
                
                // Simulate satellite count (based on accuracy)
                this.satelliteCount = Math.max(4, Math.min(12, Math.round(20 - (coords.accuracy || 50) / 5)));
                this.updateSatelliteDisplay();
                
                // Calculate time since last update
                const updateInterval = this.lastGoodPosition ? 
                    (timestamp - this.lastGoodPosition.timestamp) / 1000 : 0;
                this.updateGPSSpeedDisplay(updateInterval);
                
                // Apply enhanced Kalman filtering
                const filteredCoords = this.applyEnhancedKalmanFilter(coords);
                
                // Apply speed filtering
                if (!this.passesSpeedFilter(filteredCoords, coords.speed)) {
                    console.warn('Position rejected by speed filter');
                    return;
                }
                
                // Create GPS point
                const gpsPoint = {
                    latitude: filteredCoords.latitude,
                    longitude: filteredCoords.longitude,
                    altitude: coords.altitude,
                    accuracy: coords.accuracy,
                    altitudeAccuracy: coords.altitudeAccuracy,
                    heading: coords.heading,
                    speed: coords.speed,
                    timestamp: timestamp,
                    source: source,
                    sensorData: {
                        orientation: { ...this.deviceOrientation },
                        motion: { ...this.deviceMotion },
                        compassCalibrated: this.compassCalibrated
                    }
                };
                
                // Store raw data
                this.trackData.push(gpsPoint);
                this.lastGoodPosition = position;
                
                // Add to position history for dead reckoning
                this.positionHistory.push(gpsPoint);
                if (this.positionHistory.length > 10) {
                    this.positionHistory.shift();
                }
                
                // Apply filtering
                if (this.shouldIncludePoint(gpsPoint)) {
                    this.filteredData.push(gpsPoint);
                    this.updateStatistics(gpsPoint);
                    this.updateTrackBounds(gpsPoint);
                    this.drawTrack();
                }
                
                // Update displays
                this.updateCoordinatesDisplay(gpsPoint);
                this.updateAccuracyIndicator(coords.accuracy);
                this.updateStatisticsDisplay();
                
                // Track data usage (approximate)
                const dataSize = JSON.stringify(gpsPoint).length;
                this.trackDataUsage(dataSize);
                
                // Reset dead reckoning if active
                if (this.deadReckoningActive) {
                    this.deadReckoningActive = false;
                    this.showNotification('GPS signal restored', 'success');
                }
            }
            
            onPositionError(error) {
                let message = 'GPS Error: ';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        message += 'Location access denied by user';
                        this.updateGPSStatus('lost');
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += 'Location information unavailable';
                        this.updateGPSStatus('lost');
                        this.startDeadReckoning();
                        break;
                    case error.TIMEOUT:
                        message += 'Location request timed out';
                        this.updateGPSStatus('acquiring');
                        break;
                    default:
                        message += 'Unknown error occurred';
                        this.updateGPSStatus('lost');
                        break;
                }
                
                console.error(message);
                this.showError(message);
                
                // Update accuracy indicator
                this.updateAccuracyIndicator(null);
                
                // Start dead reckoning if GPS is lost and option is enabled
                if (error.code === error.POSITION_UNAVAILABLE && this.getSetting('deadReckoning', true)) {
                    this.startDeadReckoning();
                }
            }
            
            startDeadReckoning() {
                if (this.deadReckoningActive || this.positionHistory.length < 3) return;
                
                console.log('Starting dead reckoning...');
                this.deadReckoningActive = true;
                this.showNotification('GPS lost - Using dead reckoning', 'warning');
                
                // Use sensor data and last known position to estimate location
                const deadReckoningInterval = setInterval(() => {
                    if (!this.deadReckoningActive || !this.isTracking || this.isPaused) {
                        clearInterval(deadReckoningInterval);
                        return;
                    }
                    
                    const estimatedPosition = this.calculateDeadReckoningPosition();
                    if (estimatedPosition) {
                        // Add estimated position with lower confidence
                        const drPoint = {
                            ...estimatedPosition,
                            accuracy: 100, // Low accuracy for dead reckoning
                            source: 'dead-reckoning',
                            timestamp: Date.now()
                        };
                        
                        this.trackData.push(drPoint);
                        this.filteredData.push(drPoint);
                        this.updateCoordinatesDisplay(drPoint);
                        this.drawTrack();
                    }
                }, 2000); // Update every 2 seconds during dead reckoning
            }
            
            calculateDeadReckoningPosition() {
                if (this.positionHistory.length < 2) return null;
                
                const lastPos = this.positionHistory[this.positionHistory.length - 1];
                const prevPos = this.positionHistory[this.positionHistory.length - 2];
                
                // Calculate velocity vector
                const timeDiff = (lastPos.timestamp - prevPos.timestamp) / 1000; // seconds
                const latDiff = lastPos.latitude - prevPos.latitude;
                const lonDiff = lastPos.longitude - prevPos.longitude;
                
                // Use device motion to estimate acceleration
                const accelMagnitude = Math.sqrt(
                    this.deviceMotion.x ** 2 + 
                    this.deviceMotion.y ** 2 + 
                    this.deviceMotion.z ** 2
                );
                
                // Simple dead reckoning calculation
                const timeStep = 2; // 2 seconds
                const estimatedLat = lastPos.latitude + (latDiff / timeDiff) * timeStep;
                const estimatedLon = lastPos.longitude + (lonDiff / timeDiff) * timeStep;
                
                return {
                    latitude: estimatedLat,
                    longitude: estimatedLon,
                    altitude: lastPos.altitude,
                    speed: lastPos.speed,
                    heading: this.deviceOrientation.alpha || lastPos.heading
                };
            }
            
            applyEnhancedKalmanFilter(coords) {
                const lat = this.kalmanFilter.lat;
                const lon = this.kalmanFilter.lon;
                const speed = this.kalmanFilter.speed;
                
                if (lat.x === 0) {
                    // Initialize
                    lat.x = coords.latitude;
                    lon.x = coords.longitude;
                    speed.x = coords.speed || 0;
                } else {
                    // Adjust process noise based on accuracy
                    const accuracyFactor = Math.min(1, (coords.accuracy || 50) / 50);
                    lat.q = 0.001 * accuracyFactor;
                    lon.q = 0.001 * accuracyFactor;
                    
                    // Predict
                    lat.p += lat.q;
                    lon.p += lon.q;
                    
                    // Update
                    const latK = lat.p / (lat.p + lat.r);
                    const lonK = lon.p / (lon.p + lon.r);
                    
                    lat.x += latK * (coords.latitude - lat.x);
                    lon.x += lonK * (coords.longitude - lon.x);
                    
                    lat.p *= (1 - latK);
                    lon.p *= (1 - lonK);
                    
                    // Filter speed
                    if (coords.speed !== null) {
                        speed.p += speed.q;
                        const speedK = speed.p / (speed.p + speed.r);
                        speed.x += speedK * (coords.speed - speed.x);
                        speed.p *= (1 - speedK);
                    }
                }
                
                return {
                    latitude: lat.x,
                    longitude: lon.x,
                    speed: speed.x
                };
            }
            
            passesSpeedFilter(coords, rawSpeed) {
                const maxSpeed = parseFloat(this.getSetting('maxSpeedFilter', '200')) / 3.6; // Convert km/h to m/s
                
                                if (rawSpeed && rawSpeed > maxSpeed) {
                    console.warn(`Speed filter rejected: ${rawSpeed * 3.6} km/h > ${maxSpeed * 3.6} km/h`);
                    return false;
                }
                
                // Check for unrealistic position jumps
                if (this.filteredData.length > 0) {
                    const lastPos = this.filteredData[this.filteredData.length - 1];
                    const distance = this.calculateDistance(
                        lastPos.latitude, lastPos.longitude,
                        coords.latitude, coords.longitude
                    );
                    
                    const timeDiff = (Date.now() - lastPos.timestamp) / 1000; // seconds
                    const impliedSpeed = distance / timeDiff; // m/s
                    
                    if (impliedSpeed > maxSpeed) {
                        console.warn(`Position jump rejected: implied speed ${impliedSpeed * 3.6} km/h`);
                        return false;
                    }
                }
                
                return true;
            }
            
            shouldIncludePoint(point) {
                const minAccuracy = parseFloat(this.getSetting('minAccuracy', '20'));
                const minDistance = parseFloat(this.getSetting('minDistance', '2'));
                
                // Check accuracy threshold
                if (point.accuracy && point.accuracy > minAccuracy) {
                    return false;
                }
                
                // Check minimum distance
                if (this.filteredData.length > 0) {
                    const lastPoint = this.filteredData[this.filteredData.length - 1];
                    const distance = this.calculateDistance(
                        lastPoint.latitude, lastPoint.longitude,
                        point.latitude, point.longitude
                    );
                    
                    if (distance < minDistance) {
                        return false;
                    }
                }
                
                return true;
            }
            
            updateSatelliteDisplay() {
                const satelliteCount = document.getElementById('satelliteCount');
                if (satelliteCount) {
                    satelliteCount.textContent = `Satellites: ${this.satelliteCount}`;
                    
                    // Color based on satellite count
                    if (this.satelliteCount >= 8) {
                        satelliteCount.style.background = '#4caf50';
                    } else if (this.satelliteCount >= 6) {
                        satelliteCount.style.background = '#ff9800';
                    } else {
                        satelliteCount.style.background = '#f44336';
                    }
                }
            }
            
            updateGPSSpeedDisplay(updateInterval) {
                const gpsSpeed = document.getElementById('gpsSpeed');
                if (gpsSpeed) {
                    gpsSpeed.textContent = `Update: ${updateInterval.toFixed(1)}s`;
                    
                    // Color based on update speed
                    if (updateInterval <= 1.5) {
                        gpsSpeed.style.background = '#4caf50';
                    } else if (updateInterval <= 3) {
                        gpsSpeed.style.background = '#ff9800';
                    } else {
                        gpsSpeed.style.background = '#f44336';
                    }
                }
            }
            
            updateStatistics(point) {
                // Update distance
                if (this.filteredData.length > 1) {
                    const lastPoint = this.filteredData[this.filteredData.length - 2];
                    const distance = this.calculateDistance(
                        lastPoint.latitude, lastPoint.longitude,
                        point.latitude, point.longitude
                    );
                    this.totalDistance += distance;
                }
                
                // Update max speed
                if (point.speed && point.speed > this.maxSpeed) {
                    this.maxSpeed = point.speed;
                }
                
                // Update elevation gain/loss
                if (point.altitude !== null) {
                    if (this.lastElevation !== null) {
                        const elevDiff = point.altitude - this.lastElevation;
                        if (elevDiff > 0) {
                            this.elevationGain += elevDiff;
                        } else {
                            this.elevationLoss += Math.abs(elevDiff);
                        }
                    }
                    this.lastElevation = point.altitude;
                }
            }
            
            updateTrackBounds(point) {
                if (this.trackBounds.minLat === null) {
                    this.trackBounds.minLat = this.trackBounds.maxLat = point.latitude;
                    this.trackBounds.minLon = this.trackBounds.maxLon = point.longitude;
                } else {
                    this.trackBounds.minLat = Math.min(this.trackBounds.minLat, point.latitude);
                    this.trackBounds.maxLat = Math.max(this.trackBounds.maxLat, point.latitude);
                    this.trackBounds.minLon = Math.min(this.trackBounds.minLon, point.longitude);
                    this.trackBounds.maxLon = Math.max(this.trackBounds.maxLon, point.longitude);
                }
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000; // Earth's radius in meters
                const dLat = this.toRadians(lat2 - lat1);
                const dLon = this.toRadians(lon2 - lon1);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                         Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
                         Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }
            
            toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }
            
            drawTrack() {
                if (!this.ctx || this.filteredData.length < 2) return;
                
                const canvas = this.canvas;
                const ctx = this.ctx;
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Show canvas
                canvas.style.display = 'block';
                const placeholder = document.getElementById('mapPlaceholder');
                if (placeholder) placeholder.style.display = 'none';
                
                // Calculate scale and offset
                const padding = 30;
                const bounds = this.trackBounds;
                
                if (bounds.minLat === null) return;
                
                const latRange = bounds.maxLat - bounds.minLat;
                const lonRange = bounds.maxLon - bounds.minLon;
                
                // Prevent division by zero
                const safeLatRange = Math.max(latRange, 0.001);
                const safeLonRange = Math.max(lonRange, 0.001);
                
                const scaleX = (canvas.width - 2 * padding) / safeLonRange;
                const scaleY = (canvas.height - 2 * padding) / safeLatRange;
                const scale = Math.min(scaleX, scaleY);
                
                const offsetX = (canvas.width - safeLonRange * scale) / 2;
                const offsetY = (canvas.height - safeLatRange * scale) / 2;
                
                // Draw track with different colors based on source
                this.filteredData.forEach((point, index) => {
                    if (index === 0) return;
                    
                    const prevPoint = this.filteredData[index - 1];
                    const x1 = offsetX + (prevPoint.longitude - bounds.minLon) * scale;
                    const y1 = offsetY + (bounds.maxLat - prevPoint.latitude) * scale;
                    const x2 = offsetX + (point.longitude - bounds.minLon) * scale;
                    const y2 = offsetY + (bounds.maxLat - point.latitude) * scale;
                    
                    // Set color based on source
                    if (point.source === 'dead-reckoning') {
                        ctx.strokeStyle = '#ff9800';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                    } else {
                        ctx.strokeStyle = '#2196f3';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([]);
                    }
                    
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                });
                
                // Reset line dash
                ctx.setLineDash([]);
                
                // Draw start point
                if (this.filteredData.length > 0) {
                    const startPoint = this.filteredData[0];
                    const startX = offsetX + (startPoint.longitude - bounds.minLon) * scale;
                    const startY = offsetY + (bounds.maxLat - startPoint.latitude) * scale;
                    
                    ctx.fillStyle = '#4caf50';
                    ctx.beginPath();
                    ctx.arc(startX, startY, 8, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Start label
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('START', startX, startY + 3);
                }
                
                // Draw current point
                if (this.filteredData.length > 1) {
                    const currentPoint = this.filteredData[this.filteredData.length - 1];
                    const currentX = offsetX + (currentPoint.longitude - bounds.minLon) * scale;
                    const currentY = offsetY + (bounds.maxLat - currentPoint.latitude) * scale;
                    
                    // Different color for dead reckoning
                    if (currentPoint.source === 'dead-reckoning') {
                        ctx.fillStyle = '#ff9800';
                    } else {
                        ctx.fillStyle = '#f44336';
                    }
                    
                    ctx.beginPath();
                    ctx.arc(currentX, currentY, 8, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Current position label
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    if (currentPoint.source === 'dead-reckoning') {
                        ctx.fillText('EST', currentX, currentY + 3);
                    } else {
                        ctx.fillText('NOW', currentX, currentY + 3);
                    }
                    
                    // Draw accuracy circle for GPS positions
                    if (currentPoint.accuracy && currentPoint.source !== 'dead-reckoning') {
                        const accuracyRadius = Math.min(currentPoint.accuracy * scale, 50);
                        ctx.strokeStyle = 'rgba(244, 67, 54, 0.3)';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.arc(currentX, currentY, accuracyRadius, 0, 2 * Math.PI);
                        ctx.stroke();
                    }
                }
                
                // Draw scale indicator
                this.drawScaleIndicator(ctx, canvas, scale);
                
                // Draw compass if available
                if (this.compassCalibrated) {
                    this.drawCompass(ctx, canvas);
                }
            }
            
            drawScaleIndicator(ctx, canvas, scale) {
                const scaleLength = 80; // pixels
                const realDistance = scaleLength / scale; // meters
                
                let displayDistance, unit;
                if (realDistance >= 1000) {
                    displayDistance = (realDistance / 1000).toFixed(1);
                    unit = 'km';
                } else if (realDistance >= 1) {
                    displayDistance = Math.round(realDistance);
                    unit = 'm';
                } else {
                    displayDistance = (realDistance * 100).toFixed(0);
                    unit = 'cm';
                }
                
                const x = 15;
                const y = canvas.height - 25;
                
                // Draw scale line
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + scaleLength, y);
                ctx.moveTo(x, y - 5);
                ctx.lineTo(x, y + 5);
                ctx.moveTo(x + scaleLength, y - 5);
                ctx.lineTo(x + scaleLength, y + 5);
                ctx.stroke();
                
                // Draw scale text
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${displayDistance} ${unit}`, x + scaleLength / 2, y - 8);
            }
            
            drawCompass(ctx, canvas) {
                const centerX = canvas.width - 40;
                const centerY = 40;
                const radius = 25;
                
                // Draw compass circle
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();
                
                // Draw compass needle
                const heading = this.toRadians(this.deviceOrientation.alpha || 0);
                const needleLength = radius - 3;
                
                ctx.strokeStyle = '#f44336';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(
                    centerX + Math.sin(heading) * needleLength,
                    centerY - Math.cos(heading) * needleLength
                );
                ctx.stroke();
                
                // Draw N indicator
                ctx.fillStyle = '#333';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('N', centerX, centerY - radius - 8);
            }
            
            updateCoordinatesDisplay(point) {
                const display = document.getElementById('coordinatesDisplay');
                if (!display) return;
                
                const lat = point.latitude.toFixed(8);
                const lon = point.longitude.toFixed(8);
                const alt = point.altitude ? point.altitude.toFixed(1) : '---.-';
                const acc = point.accuracy ? point.accuracy.toFixed(1) : '---.-';
                const spd = point.speed ? (point.speed * 3.6).toFixed(1) : '--.-';
                const hdg = point.heading ? point.heading.toFixed(0) : '---';
                                const time = new Date(point.timestamp).toISOString().replace('T', ' ').substr(0, 19);
                
                // Calculate HDOP and VDOP estimates based on accuracy
                const hdop = point.accuracy ? (point.accuracy / 3).toFixed(2) : '--.-';
                const vdop = point.altitudeAccuracy ? (point.altitudeAccuracy / 3).toFixed(2) : '--.-';
                
                display.innerHTML = `
                    LAT: ${lat}° LON: ${lon}°<br>
                    ALT: ${alt} m  ACC: ${acc} m<br>
                    SPD: ${spd} km/h  HDG: ${hdg}°<br>
                    UTC: ${time}<br>
                    HDOP: ${hdop} VDOP: ${vdop}
                `;
                
                // Add dead reckoning indicator
                if (point.source === 'dead-reckoning') {
                    display.style.borderLeft = '4px solid #ff9800';
                } else {
                    display.style.borderLeft = '4px solid #4caf50';
                }
            }
            
            updateAccuracyIndicator(accuracy) {
                const indicator = document.getElementById('accuracyIndicator');
                if (!indicator) return;
                
                let className, text;
                
                if (accuracy === null) {
                    className = 'accuracy-poor';
                    text = 'GPS Signal Lost';
                } else if (accuracy <= 3) {
                    className = 'accuracy-excellent';
                    text = `Excellent (±${accuracy.toFixed(1)}m)`;
                } else if (accuracy <= 8) {
                    className = 'accuracy-good';
                    text = `Good (±${accuracy.toFixed(1)}m)`;
                } else if (accuracy <= 20) {
                    className = 'accuracy-fair';
                    text = `Fair (±${accuracy.toFixed(1)}m)`;
                } else {
                    className = 'accuracy-poor';
                    text = `Poor (±${accuracy.toFixed(1)}m)`;
                }
                
                indicator.className = `accuracy-indicator ${className}`;
                indicator.textContent = `Accuracy: ${text}`;
            }
            
            updateStatisticsDisplay() {
                // Point count
                const pointCount = document.getElementById('pointCount');
                if (pointCount) {
                    pointCount.textContent = `${this.filteredData.length} points`;
                }
                
                // Total distance
                const totalDistance = document.getElementById('totalDistance');
                if (totalDistance) {
                    totalDistance.textContent = `${(this.totalDistance / 1000).toFixed(3)} km`;
                }
                
                // Duration
                const duration = document.getElementById('duration');
                if (duration && this.startTime) {
                    const elapsed = Date.now() - this.startTime - this.pausedTime;
                    duration.textContent = this.formatDuration(elapsed);
                }
                
                // Average speed
                const avgSpeed = document.getElementById('avgSpeed');
                if (avgSpeed && this.startTime) {
                    const elapsed = (Date.now() - this.startTime - this.pausedTime) / 1000 / 3600; // hours
                    const avgSpeedValue = elapsed > 0 ? (this.totalDistance / 1000) / elapsed : 0;
                    avgSpeed.textContent = `${avgSpeedValue.toFixed(2)} km/h`;
                }
                
                // Max speed
                const maxSpeed = document.getElementById('maxSpeed');
                if (maxSpeed) {
                    maxSpeed.textContent = `${(this.maxSpeed * 3.6).toFixed(2)} km/h`;
                }
                
                // Elevation gain
                const elevGain = document.getElementById('elevGain');
                if (elevGain) {
                    elevGain.textContent = `${Math.round(this.elevationGain)} m`;
                }
                
                // GPS precision
                const trackPrecision = document.getElementById('trackPrecision');
                if (trackPrecision) {
                    const precision = this.calculateGPSPrecision();
                    trackPrecision.textContent = `${precision}%`;
                }
                
                // Signal quality
                const signalQuality = document.getElementById('signalQuality');
                if (signalQuality) {
                    const quality = this.calculateSignalQuality();
                    signalQuality.textContent = quality;
                }
                
                // Update progress bars
                this.updateProgressBars();
            }
            
            calculateGPSPrecision() {
                if (this.filteredData.length < 2) return 0;
                
                let totalAccuracy = 0;
                let validPoints = 0;
                
                this.filteredData.forEach(point => {
                    if (point.accuracy && point.source !== 'dead-reckoning') {
                        totalAccuracy += point.accuracy;
                        validPoints++;
                    }
                });
                
                if (validPoints === 0) return 0;
                
                const avgAccuracy = totalAccuracy / validPoints;
                return Math.max(0, Math.min(100, Math.round(100 - (avgAccuracy / 30) * 100)));
            }
            
            calculateSignalQuality() {
                const now = Date.now();
                const timeSinceLastUpdate = (now - this.lastPositionTime) / 1000;
                
                if (this.deadReckoningActive) {
                    return 'Dead Reckoning';
                } else if (timeSinceLastUpdate > 10) {
                    return 'Signal Lost';
                } else if (this.satelliteCount >= 8) {
                    return 'Excellent';
                } else if (this.satelliteCount >= 6) {
                    return 'Good';
                } else if (this.satelliteCount >= 4) {
                    return 'Fair';
                } else {
                    return 'Poor';
                }
            }
            
            updateProgressBars() {
                // Point progress (scale to 1000 points)
                const pointProgress = document.getElementById('pointProgress');
                if (pointProgress) {
                    const progress = Math.min(100, (this.filteredData.length / 1000) * 100);
                    pointProgress.style.width = `${progress}%`;
                }
                
                // Distance progress (scale to 10km)
                const distanceProgress = document.getElementById('distanceProgress');
                if (distanceProgress) {
                    const progress = Math.min(100, (this.totalDistance / 10000) * 100);
                    distanceProgress.style.width = `${progress}%`;
                }
                
                // Speed progress (scale to max recorded speed)
                const speedProgress = document.getElementById('speedProgress');
                if (speedProgress && this.maxSpeed > 0) {
                    const progress = Math.min(100, (this.maxSpeed * 3.6 / 100) * 100); // Scale to 100 km/h
                    speedProgress.style.width = `${progress}%`;
                }
            }
            
            formatDuration(milliseconds) {
                const seconds = Math.floor(milliseconds / 1000);
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            updateUI() {
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const resumeBtn = document.getElementById('resumeBtn');
                const exportButtons = ['exportGpxBtn', 'exportKmlBtn', 'exportJsonBtn'];
                
                if (this.isTracking) {
                    if (startBtn) startBtn.disabled = true;
                    if (stopBtn) stopBtn.disabled = false;
                    
                    if (this.isPaused) {
                        if (pauseBtn) pauseBtn.style.display = 'none';
                        if (resumeBtn) resumeBtn.style.display = 'inline-block';
                    } else {
                        if (pauseBtn) pauseBtn.disabled = false;
                        if (resumeBtn) resumeBtn.style.display = 'none';
                    }
                } else {
                    if (startBtn) startBtn.disabled = false;
                    if (stopBtn) stopBtn.disabled = true;
                    if (pauseBtn) pauseBtn.disabled = true;
                    if (resumeBtn) resumeBtn.style.display = 'none';
                }
                
                // Enable export buttons if we have data
                const hasData = this.filteredData.length > 0;
                exportButtons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) btn.disabled = !hasData;
                });
                
                // Update status displays
                const trackingStatus = document.getElementById('trackingStatus');
                if (trackingStatus) {
                    if (this.isTracking) {
                        if (this.isPaused) {
                            trackingStatus.textContent = 'Paused';
                            trackingStatus.className = 'status inactive';
                        } else {
                            trackingStatus.textContent = 'Active';
                            trackingStatus.className = 'status active';
                        }
                    } else {
                        trackingStatus.textContent = 'Inactive';
                        trackingStatus.className = 'status inactive';
                    }
                }
            }
            
            startStatusUpdates() {
                setInterval(() => {
                    this.updateStatisticsDisplay();
                    this.updateDataUsageDisplay();
                    
                    // Check for GPS timeout
                    if (this.isTracking && !this.isPaused) {
                        const now = Date.now();
                        const timeSinceLastUpdate = (now - this.lastPositionTime) / 1000;
                        
                        if (timeSinceLastUpdate > 30) { // 30 seconds timeout
                            this.updateGPSStatus('lost');
                            if (this.getSetting('deadReckoning', true) && !this.deadReckoningActive) {
                                this.startDeadReckoning();
                            }
                        }
                    }
                }, 1000);
            }
            
            clearData() {
                if (this.isTracking) {
                    if (!confirm('Stop tracking and clear all data?')) return;
                    this.stopTracking();
                }
                
                // Reset all tracking data
                this.trackData = [];
                this.filteredData = [];
                this.positionHistory = [];
                this.totalDistance = 0;
                this.maxSpeed = 0;
                this.elevationGain = 0;
                this.elevationLoss = 0;
                this.lastElevation = null;
                this.startTime = null;
                this.pausedTime = 0;
                this.pauseStartTime = null;
                this.lastPositionTime = 0;
                this.satelliteCount = 0;
                this.deadReckoningActive = false;
                this.trackBounds = { minLat: null, maxLat: null, minLon: null, maxLon: null };
                
                // Reset Kalman filter
                this.kalmanFilter = {
                    lat: { x: 0, p: 1000, q: 0.001, r: 0.5 },
                    lon: { x: 0, p: 1000, q: 0.001, r: 0.5 },
                    speed: { x: 0, p: 100, q: 0.1, r: 1 }
                };
                
                // Reset session data usage
                this.dataUsage.wifi.session = 0;
                this.dataUsage.cellular.session = 0;
                this.dataUsage.total.session = 0;
                
                // Clear canvas
                if (this.ctx) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.canvas.style.display = 'none';
                    const placeholder = document.getElementById('mapPlaceholder');
                    if (placeholder) placeholder.style.display = 'flex';
                }
                
                // Reset displays
                document.getElementById('coordinatesDisplay').innerHTML = `
                    LAT: -.--------° LON: -.--------°<br>
                    ALT: ---.- m  ACC: ---.- m<br>
                    SPD: --.- km/h  HDG: ---°<br>
                    UTC: ----/--/-- --:--:--<br>
                    HDOP: --.-- VDOP: --.--
                `;
                
                this.updateGPSStatus('ready');
                this.updateAccuracyIndicator(null);
                this.updateStatisticsDisplay();
                this.updateDataUsageDisplay();
                this.updateUI();
                
                console.log('All data cleared');
                this.showNotification('All data cleared', 'info');
            }
            
            getSetting(key, defaultValue) {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        return element.checked;
                    } else {
                        return element.value;
                    }
                }
                return defaultValue;
            }
            
            loadSettings() {
                try {
                    const saved = localStorage.getItem('gpsTrackerSettings');
                    if (saved) {
                        const settings = JSON.parse(saved);
                        
                        // Apply settings to form elements
                        Object.keys(settings).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = settings[key];
                                } else {
                                    element.value = settings[key];
                                }
                            }
                        });
                        
                        // Apply network settings
                        this.networkSettings = { ...this.networkSettings, ...settings.networkSettings };
                        this.dataUsage.mode = settings.dataSavingMode || 'offline';
                    }
                } catch (error) {
                    console.warn('Failed to load settings:', error);
                }
            }
            
            saveSettings() {
                try {
                    const settings = {
                        gpsInterval: this.getSetting('gpsInterval', '1000'),
                        highAccuracy: this.getSetting('highAccuracy', true),
                        gpsWarming: this.getSetting('gpsWarming', true),
                        multipleRequests: this.getSetting('multipleRequests', true),
                        positionTimeout: this.getSetting('positionTimeout', '10000'),
                        maximumAge: this.getSetting('maximumAge', '5000'),
                        allowWifi: this.getSetting('allowWifi', true),
                        allowCellular: this.getSetting('allowCellular', true),
                                                wifiOnlyMode: this.getSetting('wifiOnlyMode', false),
                        cellularDataLimit: parseInt(this.getSetting('cellularDataLimit', '50')) * 1024 * 1024,
                        sensorFusion: this.getSetting('sensorFusion', true),
                        trackSmoothing: this.getSetting('trackSmoothing', true),
                        kalmanFiltering: this.getSetting('kalmanFiltering', true),
                        minAccuracy: this.getSetting('minAccuracy', '20'),
                        minDistance: this.getSetting('minDistance', '2'),
                        maxSpeedFilter: this.getSetting('maxSpeedFilter', '200'),
                        dataSavingMode: this.getSetting('dataSavingMode', 'offline'),
                        deadReckoning: this.getSetting('deadReckoning', true),
                        predictiveTracking: this.getSetting('predictiveTracking', false),
                        enableMapTiles: this.getSetting('enableMapTiles', false),
                        enableElevationAPI: this.getSetting('enableElevationAPI', false),
                        enableCloudSync: this.getSetting('enableCloudSync', false),
                        networkSettings: this.networkSettings
                    };
                    
                    localStorage.setItem('gpsTrackerSettings', JSON.stringify(settings));
                    
                    // Apply network settings
                    this.networkSettings.allowWifi = settings.allowWifi;
                    this.networkSettings.allowCellular = settings.allowCellular;
                    this.networkSettings.wifiOnlyMode = settings.wifiOnlyMode;
                    this.networkSettings.cellularDataLimit = settings.cellularDataLimit;
                    this.networkSettings.dataSavingMode = settings.dataSavingMode;
                    
                    this.dataUsage.mode = settings.dataSavingMode;
                    this.updateDataUsageDisplay();
                    
                    console.log('Settings saved successfully');
                    this.showNotification('Settings saved successfully', 'success');
                    this.closeSettings();
                } catch (error) {
                    console.error('Failed to save settings:', error);
                    this.showError('Failed to save settings: ' + error.message);
                }
            }
            
            resetSettings() {
                if (!confirm('Reset all settings to default values?')) return;
                
                try {
                    // Clear stored settings
                    localStorage.removeItem('gpsTrackerSettings');
                    
                    // Reset form elements to defaults
                    const defaults = {
                        gpsInterval: '1000',
                        highAccuracy: true,
                        gpsWarming: true,
                        multipleRequests: true,
                        positionTimeout: '10000',
                        maximumAge: '5000',
                        allowWifi: true,
                        allowCellular: true,
                        wifiOnlyMode: false,
                        cellularDataLimit: '50',
                        sensorFusion: true,
                        trackSmoothing: true,
                        kalmanFiltering: true,
                        minAccuracy: '20',
                        minDistance: '2',
                        maxSpeedFilter: '200',
                        dataSavingMode: 'offline',
                        deadReckoning: true,
                        predictiveTracking: false,
                        enableMapTiles: false,
                        enableElevationAPI: false,
                        enableCloudSync: false
                    };
                    
                    Object.keys(defaults).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = defaults[key];
                            } else {
                                element.value = defaults[key];
                            }
                        }
                    });
                    
                    // Reset network settings
                    this.networkSettings = {
                        allowWifi: true,
                        allowCellular: true,
                        wifiOnlyMode: false,
                        cellularDataLimit: 50 * 1024 * 1024,
                        dataSavingMode: 'offline'
                    };
                    
                    this.showNotification('Settings reset to defaults', 'success');
                } catch (error) {
                    console.error('Failed to reset settings:', error);
                    this.showError('Failed to reset settings: ' + error.message);
                }
            }
            
            closeSettings() {
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) {
                    settingsModal.style.display = 'none';
                }
            }
            
            showSettings() {
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) {
                    settingsModal.style.display = 'block';
                    this.updateSettingsInfo();
                }
            }
            
            updateSettingsInfo() {
                // Update storage info
                const storageUsed = document.getElementById('storageUsed');
                if (storageUsed) {
                    const dataSize = JSON.stringify(this.trackData).length;
                    storageUsed.textContent = this.formatDataUsage(dataSize);
                }
                
                const pointsStored = document.getElementById('pointsStored');
                if (pointsStored) {
                    pointsStored.textContent = this.trackData.length.toString();
                }
                
                const sessionTime = document.getElementById('sessionTime');
                if (sessionTime && this.startTime) {
                    const elapsed = Date.now() - this.startTime - this.pausedTime;
                    sessionTime.textContent = this.formatDuration(elapsed).substr(0, 5); // HH:MM
                }
                
                const sessionWifiData = document.getElementById('sessionWifiData');
                if (sessionWifiData) {
                    sessionWifiData.textContent = this.formatDataUsage(this.dataUsage.wifi.session);
                }
                
                const sessionCellularData = document.getElementById('sessionCellularData');
                if (sessionCellularData) {
                    sessionCellularData.textContent = this.formatDataUsage(this.dataUsage.cellular.session);
                }
            }
            
            exportGPX() {
                if (this.filteredData.length === 0) {
                    this.showError('No track data to export');
                    return;
                }
                
                const gpx = this.generateGPX();
                this.downloadFile(gpx, 'gps_track.gpx', 'application/gpx+xml');
                this.showNotification('GPX file exported successfully', 'success');
            }
            
            exportKML() {
                if (this.filteredData.length === 0) {
                    this.showError('No track data to export');
                    return;
                }
                
                const kml = this.generateKML();
                this.downloadFile(kml, 'gps_track.kml', 'application/vnd.google-earth.kml+xml');
                this.showNotification('KML file exported successfully', 'success');
            }
            
            exportJSON() {
                if (this.filteredData.length === 0) {
                    this.showError('No track data to export');
                    return;
                }
                
                const json = this.generateJSON();
                this.downloadFile(json, 'gps_track.json', 'application/json');
                this.showNotification('JSON file exported successfully', 'success');
            }
            
            generateGPX() {
                const now = new Date().toISOString();
                const startTime = this.startTime ? new Date(this.startTime).toISOString() : now;
                
                let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Ultra GPS Tracker Pro" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Ultra GPS Track</name>
    <desc>GPS Track recorded with Ultra GPS Tracker Pro</desc>
    <author>
      <name>Ultra GPS Tracker Pro</name>
    </author>
    <time>${startTime}</time>
    <bounds minlat="${this.trackBounds.minLat}" minlon="${this.trackBounds.minLon}" maxlat="${this.trackBounds.maxLat}" maxlon="${this.trackBounds.maxLon}"/>
  </metadata>
  <trk>
    <name>GPS Track ${startTime.substr(0, 10)}</name>
    <desc>Total distance: ${(this.totalDistance / 1000).toFixed(2)} km</desc>
    <trkseg>`;
                
                this.filteredData.forEach((point, index) => {
                    const time = new Date(point.timestamp).toISOString();
                    gpx += `
      <trkpt lat="${point.latitude.toFixed(8)}" lon="${point.longitude.toFixed(8)}">`;
                    
                    if (point.altitude !== null) {
                        gpx += `
        <ele>${point.altitude.toFixed(2)}</ele>`;
                    }
                    
                    gpx += `
        <time>${time}</time>`;
                    
                    if (point.speed !== null) {
                        gpx += `
        <speed>${point.speed.toFixed(2)}</speed>`;
                    }
                    
                    if (point.heading !== null) {
                        gpx += `
        <course>${point.heading.toFixed(1)}</course>`;
                    }
                    
                    gpx += `
        <extensions>
          <accuracy>${point.accuracy || 0}</accuracy>
          <source>${point.source || 'gps'}</source>`;
                    
                    if (point.sensorData) {
                        gpx += `
          <compass>${(point.sensorData.orientation.alpha || 0).toFixed(2)}</compass>`;
                    }
                    
                    gpx += `
        </extensions>
      </trkpt>`;
                });
                
                gpx += `
    </trkseg>
  </trk>
</gpx>`;
                
                return gpx;
            }
            
            generateKML() {
                const now = new Date().toISOString();
                const startTime = this.startTime ? new Date(this.startTime).toISOString() : now;
                
                let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Ultra GPS Track</name>
    <description>GPS Track recorded on ${startTime.substr(0, 10)}</description>
    <Style id="trackStyle">
      <LineStyle>
        <color>ff0000ff</color>
        <width>4</width>
      </LineStyle>
    </Style>
    <Style id="deadReckoningStyle">
      <LineStyle>
        <color>ff0080ff</color>
        <width>3</width>
      </LineStyle>
    </Style>
    <Placemark>
      <name>GPS Track - ${startTime.substr(0, 10)}</name>
      <description>
        Distance: ${(this.totalDistance / 1000).toFixed(2)} km
        Max Speed: ${(this.maxSpeed * 3.6).toFixed(2)} km/h
        Duration: ${this.formatDuration(Date.now() - (this.startTime || Date.now()))}
        Points: ${this.filteredData.length}
      </description>
      <styleUrl>#trackStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <altitudeMode>absolute</altitudeMode>
        <coordinates>`;
                
                this.filteredData.forEach(point => {
                    const alt = point.altitude || 0;
                    kml += `${point.longitude.toFixed(8)},${point.latitude.toFixed(8)},${alt.toFixed(2)} `;
                });
                
                kml += `
        </coordinates>
      </LineString>
    </Placemark>
  </Document>
</kml>`;
                
                return kml;
            }
            
            generateJSON() {
                const metadata = {
                    name: 'Ultra GPS Track',
                    created: new Date().toISOString(),
                    startTime: this.startTime ? new Date(this.startTime).toISOString() : null,
                    totalDistance: this.totalDistance,
                    maxSpeed: this.maxSpeed,
                    elevationGain: this.elevationGain,
                    elevationLoss: this.elevationLoss,
                    duration: this.startTime ? Date.now() - this.startTime - this.pausedTime : 0,
                    pointCount: this.filteredData.length,
                    bounds: this.trackBounds,
                    settings: {
                        gpsInterval: this.getSetting('gpsInterval', '1000'),
                        highAccuracy: this.getSetting('highAccuracy', true),
                        minAccuracy: this.getSetting('minAccuracy', '20'),
                        minDistance: this.getSetting('minDistance', '2'),
                        dataSavingMode: this.getSetting('dataSavingMode', 'offline')
                    },
                    dataUsage: {
                        wifi: this.dataUsage.wifi.session,
                        cellular: this.dataUsage.cellular.session,
                        total: this.dataUsage.total.session
                    }
                };
                
                const trackData = {
                    metadata: metadata,
                    track: this.filteredData.map((point, index) => ({
                        index: index,
                        latitude: point.latitude,
                        longitude: point.longitude,
                        altitude: point.altitude,
                        accuracy: point.accuracy,
                        altitudeAccuracy: point.altitudeAccuracy,
                        speed: point.speed,
                        heading: point.heading,
                        timestamp: point.timestamp,
                        source: point.source || 'gps',
                        sensorData: point.sensorData || null
                    }))
                };
                
                return JSON.stringify(trackData, null, 2);
            }
            
            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                                        padding: 15px 25px;
                    border-radius: 10px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    max-width: 350px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.1);
                `;
                
                // Set background color based on type
                switch (type) {
                    case 'success':
                        notification.style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
                        break;
                    case 'error':
                        notification.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
                        break;
                    case 'warning':
                        notification.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
                        break;
                    default:
                        notification.style.background = 'linear-gradient(135deg, #2196f3, #1976d2)';
                }
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // Remove after 4 seconds
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 4000);
            }
            
            showError(message) {
                this.showNotification(message, 'error');
                console.error(message);
            }
        }
        
        // Global tracker instance
        let gpsTracker;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            gpsTracker = new UltraGPSTracker();
            console.log('Ultra GPS Tracker Pro initialized');
        });
        
        // Global functions for UI interaction
        function startTracking() {
            if (gpsTracker) gpsTracker.startTracking();
        }
        
        function stopTracking() {
            if (gpsTracker) gpsTracker.stopTracking();
        }
        
        function pauseTracking() {
            if (gpsTracker) gpsTracker.pauseTracking();
        }
        
        function resumeTracking() {
            if (gpsTracker) gpsTracker.resumeTracking();
        }
        
        function clearData() {
            if (gpsTracker) gpsTracker.clearData();
        }
        
        function showSettings() {
            if (gpsTracker) gpsTracker.showSettings();
        }
        
        function closeSettings() {
            if (gpsTracker) gpsTracker.closeSettings();
        }
        
        function saveSettings() {
            if (gpsTracker) gpsTracker.saveSettings();
        }
        
        function resetSettings() {
            if (gpsTracker) gpsTracker.resetSettings();
        }
        
        function exportGPX() {
            if (gpsTracker) gpsTracker.exportGPX();
        }
        
        function exportKML() {
            if (gpsTracker) gpsTracker.exportKML();
        }
        
        function exportJSON() {
            if (gpsTracker) gpsTracker.exportJSON();
        }
        
        function toggleCollapsible(element) {
            const content = element.nextElementSibling;
            const chevron = element.querySelector('.chevron');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                chevron.classList.remove('active');
                chevron.textContent = '▼';
            } else {
                content.classList.add('active');
                chevron.classList.add('active');
                chevron.textContent = '▲';
            }
        }
        
        // Enhanced event listeners
        window.addEventListener('online', function() {
            if (gpsTracker) {
                gpsTracker.updateNetworkStatus();
                gpsTracker.showNotification('Connection restored - GPS accuracy may improve', 'success');
            }
        });
        
        window.addEventListener('offline', function() {
            if (gpsTracker) {
                gpsTracker.updateNetworkStatus();
                gpsTracker.showNotification('Working offline - GPS tracking continues', 'warning');
            }
        });
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (gpsTracker && gpsTracker.isTracking) {
                if (document.hidden) {
                    console.log('App backgrounded - GPS tracking continues');
                } else {
                    console.log('App foregrounded - updating displays');
                    gpsTracker.updateStatisticsDisplay();
                    gpsTracker.drawTrack();
                }
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (gpsTracker && gpsTracker.canvas) {
                const container = gpsTracker.canvas.parentElement;
                gpsTracker.canvas.width = container.clientWidth;
                gpsTracker.canvas.height = container.clientHeight;
                gpsTracker.drawTrack();
            }
        });
        
        // Prevent accidental page refresh during tracking
        window.addEventListener('beforeunload', function(e) {
            if (gpsTracker && gpsTracker.isTracking) {
                const message = 'GPS tracking is active. Leaving will stop tracking and may lose unsaved data.';
                e.returnValue = message;
                return message;
            }
        });
        
        // Handle modal clicks
        window.addEventListener('click', function(event) {
            const settingsModal = document.getElementById('settingsModal');
            if (event.target === settingsModal) {
                closeSettings();
            }
        });
        
        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Prevent shortcuts when typing in input fields
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                return;
            }
            
            if (event.ctrlKey || event.metaKey) {
                switch (event.key.toLowerCase()) {
                    case 's':
                        event.preventDefault();
                        if (gpsTracker && gpsTracker.isTracking) {
                            stopTracking();
                        } else {
                            startTracking();
                        }
                        break;
                    case 'p':
                        event.preventDefault();
                        if (gpsTracker && gpsTracker.isTracking) {
                            if (gpsTracker.isPaused) {
                                resumeTracking();
                            } else {
                                pauseTracking();
                            }
                        }
                        break;
                    case 'e':
                        event.preventDefault();
                        if (gpsTracker && gpsTracker.filteredData.length > 0) {
                            exportGPX();
                        }
                        break;
                    case 'k':
                        event.preventDefault();
                        if (gpsTracker && gpsTracker.filteredData.length > 0) {
                            exportKML();
                        }
                        break;
                    case 'j':
                        event.preventDefault();
                        if (gpsTracker && gpsTracker.filteredData.length > 0) {
                            exportJSON();
                        }
                        break;
                    case ',':
                        event.preventDefault();
                        showSettings();
                        break;
                }
            }
            
            // Non-Ctrl shortcuts
            switch (event.key) {
                case 'Escape':
                    closeSettings();
                    break;
                case 'Delete':
                    if (event.shiftKey) {
                        event.preventDefault();
                        clearData();
                    }
                    break;
                case 'F1':
                    event.preventDefault();
                    showHelp();
                    break;
            }
        });
        
        // Service Worker registration for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // Enhanced touch gestures for mobile
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
            if (!touchStartX || !touchStartY) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const touchEndTime = Date.now();
            
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;
            const timeDiff = touchEndTime - touchStartTime;
            
            // Swipe detection (minimum 50px and less than 500ms)
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50 && timeDiff < 500) {
                if (diffX > 0) {
                    // Swipe left - show settings
                    if (gpsTracker && !document.getElementById('settingsModal').style.display) {
                        showSettings();
                    }
                } else {
                    // Swipe right - close settings or start/stop tracking
                    if (document.getElementById('settingsModal').style.display === 'block') {
                        closeSettings();
                    } else if (gpsTracker) {
                        if (gpsTracker.isTracking) {
                            stopTracking();
                        } else {
                            startTracking();
                        }
                    }
                }
            }
            
            // Vertical swipe detection
            if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 50 && timeDiff < 500) {
                if (diffY > 0) {
                    // Swipe up - pause/resume
                    if (gpsTracker && gpsTracker.isTracking) {
                        if (gpsTracker.isPaused) {
                            resumeTracking();
                        } else {
                            pauseTracking();
                        }
                    }
                } else {
                    // Swipe down - refresh/clear
                    if (gpsTracker && !gpsTracker.isTracking) {
                        clearData();
                    }
                }
            }
            
            touchStartX = 0;
            touchStartY = 0;
            touchStartTime = 0;
        }, { passive: true });
        
        // Battery status monitoring
        if ('getBattery' in navigator) {
            navigator.getBattery().then(function(battery) {
                function updateBatteryInfo() {
                    const batteryLevel = Math.round(battery.level * 100);
                    const isCharging = battery.charging;
                    
                    console.log(`Battery: ${batteryLevel}% ${isCharging ? '(Charging)' : ''}`);
                    
                    // Update battery indicator if exists
                    const batteryIndicator = document.getElementById('batteryIndicator');
                    if (batteryIndicator) {
                        batteryIndicator.textContent = `${batteryLevel}%`;
                        batteryIndicator.className = `battery-indicator ${isCharging ? 'charging' : ''}`;
                        
                        if (batteryLevel < 15 && !isCharging) {
                            batteryIndicator.classList.add('low');
                        } else {
                            batteryIndicator.classList.remove('low');
                        }
                    }
                    
                    // Show low battery warning during tracking
                    if (gpsTracker && gpsTracker.isTracking && batteryLevel < 15 && !isCharging) {
                        gpsTracker.showNotification('Low battery - Consider connecting charger', 'warning');
                    }
                }
                
                battery.addEventListener('chargingchange', updateBatteryInfo);
                battery.addEventListener('levelchange', updateBatteryInfo);
                updateBatteryInfo();
            }).catch(function(error) {
                console.log('Battery API not available:', error);
            });
        }
        
        // Performance monitoring
        let performanceMetrics = {
            startTime: performance.now(),
            gpsUpdates: 0,
            renderCalls: 0,
            errorCount: 0
        };
        
        // Log performance metrics every 30 seconds during tracking
        setInterval(function() {
            if (gpsTracker && gpsTracker.isTracking) {
                const runtime = (performance.now() - performanceMetrics.startTime) / 1000;
                const gpsRate = performanceMetrics.gpsUpdates / runtime;
                const renderRate = performanceMetrics.renderCalls / runtime;
                
                console.log(`Performance: GPS ${gpsRate.toFixed(2)}/s, Render ${renderRate.toFixed(2)}/s, Errors: ${performanceMetrics.errorCount}`);
                
                // Reset metrics
                performanceMetrics.gpsUpdates = 0;
                performanceMetrics.renderCalls = 0;
                performanceMetrics.errorCount = 0;
                performanceMetrics.startTime = performance.now();
            }
        }, 30000);
        
        // Global error handler
        window.addEventListener('error', function(event) {
            performanceMetrics.errorCount++;
            console.error('Global error:', event.error);
            
            if (gpsTracker) {
                gpsTracker.showError('An unexpected error occurred. Check console for details.');
            }
        });
        
        // Help system
        function showHelp() {
            const helpModal = document.createElement('div');
            helpModal.className = 'modal';
            helpModal.style.display = 'block';
            helpModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>📖 Help & Shortcuts</h2>
                        <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <h3>🎮 Keyboard Shortcuts</h3>
                        <ul>
                                                        <li><strong>Ctrl+S:</strong> Start/Stop tracking</li>
                            <li><strong>Ctrl+P:</strong> Pause/Resume tracking</li>
                            <li><strong>Ctrl+E:</strong> Export GPX file</li>
                            <li><strong>Ctrl+K:</strong> Export KML file</li>
                            <li><strong>Ctrl+J:</strong> Export JSON file</li>
                            <li><strong>Ctrl+,:</strong> Open settings</li>
                            <li><strong>Shift+Delete:</strong> Clear all data</li>
                            <li><strong>Escape:</strong> Close modals</li>
                            <li><strong>F1:</strong> Show this help</li>
                        </ul>
                        
                        <h3>📱 Touch Gestures</h3>
                        <ul>
                            <li><strong>Swipe Left:</strong> Open settings</li>
                            <li><strong>Swipe Right:</strong> Start/Stop tracking</li>
                            <li><strong>Swipe Up:</strong> Pause/Resume tracking</li>
                            <li><strong>Swipe Down:</strong> Clear data (when stopped)</li>
                        </ul>
                        
                        <h3>🛰️ GPS Status Indicators</h3>
                        <ul>
                            <li><strong>Excellent (≤3m):</strong> High precision tracking</li>
                            <li><strong>Good (≤8m):</strong> Good for most activities</li>
                            <li><strong>Fair (≤20m):</strong> Adequate for general tracking</li>
                            <li><strong>Poor (>20m):</strong> Low precision, may be filtered</li>
                        </ul>
                        
                        <h3>💾 Data Management</h3>
                        <ul>
                            <li><strong>Offline Mode:</strong> No internet required</li>
                            <li><strong>Auto-save:</strong> Data saved to browser storage</li>
                            <li><strong>Export formats:</strong> GPX, KML, JSON</li>
                            <li><strong>Dead Reckoning:</strong> Continues when GPS is lost</li>
                        </ul>
                        
                        <h3>⚙️ Tips for Best Results</h3>
                        <ul>
                            <li>Enable high accuracy in device settings</li>
                            <li>Keep device screen on during tracking</li>
                            <li>Avoid tall buildings and dense forests</li>
                            <li>Calibrate compass before starting</li>
                            <li>Use external battery for long tracks</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
            
            // Close on background click
            helpModal.addEventListener('click', function(e) {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }
        
        // Debug mode functionality
        let debugMode = false;
        let debugConsole = null;
        
        function toggleDebugMode() {
            debugMode = !debugMode;
            console.log('Debug mode:', debugMode ? 'ENABLED' : 'DISABLED');
            
            if (debugMode) {
                createDebugConsole();
                document.body.classList.add('debug-mode');
                if (gpsTracker) {
                    gpsTracker.showNotification('Debug mode enabled', 'info');
                }
            } else {
                if (debugConsole) {
                    debugConsole.remove();
                    debugConsole = null;
                }
                document.body.classList.remove('debug-mode');
                if (gpsTracker) {
                    gpsTracker.showNotification('Debug mode disabled', 'info');
                }
            }
        }
        
        function createDebugConsole() {
            debugConsole = document.createElement('div');
            debugConsole.style.cssText = `
                position: fixed;
                bottom: 10px;
                left: 10px;
                width: 300px;
                height: 200px;
                background: rgba(0, 0, 0, 0.9);
                color: #00ff00;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                padding: 10px;
                border-radius: 5px;
                overflow-y: auto;
                z-index: 9999;
                border: 1px solid #333;
            `;
            
            debugConsole.innerHTML = '<div id="debugOutput">Debug Console Active...</div>';
            document.body.appendChild(debugConsole);
            
            // Override console.log for debug output
            const originalLog = console.log;
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (debugMode && debugConsole) {
                    const output = document.getElementById('debugOutput');
                    if (output) {
                        const timestamp = new Date().toLocaleTimeString();
                        output.innerHTML += `<br>[${timestamp}] ${args.join(' ')}`;
                        output.scrollTop = output.scrollHeight;
                    }
                }
            };
        }
        
        // Double-tap on title to toggle debug mode
        let titleTapCount = 0;
        let titleTapTimer = null;
        
        document.querySelector('.header h1').addEventListener('click', function() {
            titleTapCount++;
            
            if (titleTapTimer) {
                clearTimeout(titleTapTimer);
            }
            
            titleTapTimer = setTimeout(function() {
                if (titleTapCount === 2) {
                    toggleDebugMode();
                }
                titleTapCount = 0;
            }, 400);
        });
        
        // Memory usage monitoring
        function logMemoryUsage() {
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                const total = Math.round(performance.memory.totalJSHeapSize / 1024 / 1024);
                const limit = Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024);
                
                console.log(`Memory: ${used}MB used, ${total}MB total, ${limit}MB limit`);
                
                // Warn if memory usage is high
                if (used > limit * 0.8) {
                    if (gpsTracker) {
                        gpsTracker.showNotification('High memory usage detected', 'warning');
                    }
                }
            }
        }
        
        // Log memory usage every 60 seconds during tracking
        setInterval(function() {
            if (gpsTracker && gpsTracker.isTracking) {
                logMemoryUsage();
            }
        }, 60000);
        
        // Connection type monitoring
        function logConnectionInfo() {
            if ('connection' in navigator) {
                const connection = navigator.connection;
                console.log(`Connection: ${connection.effectiveType}, ${connection.downlink}Mbps`);
                
                // Update network status indicator
                const networkType = document.getElementById('networkType');
                if (networkType) {
                    networkType.textContent = connection.effectiveType.toUpperCase();
                    
                    // Color based on connection quality
                    if (connection.effectiveType === '4g' || connection.effectiveType === '5g') {
                        networkType.style.background = '#4caf50';
                    } else if (connection.effectiveType === '3g') {
                        networkType.style.background = '#ff9800';
                    } else {
                        networkType.style.background = '#f44336';
                    }
                }
            }
        }
        
        // Monitor connection changes
        if ('connection' in navigator) {
            navigator.connection.addEventListener('change', logConnectionInfo);
            logConnectionInfo(); // Initial call
        }
        
        // Wake lock management
        let wakeLockSupported = 'wakeLock' in navigator;
        
        function updateWakeLockStatus() {
            const wakeLockStatus = document.getElementById('wakeLockStatus');
            if (wakeLockStatus) {
                if (gpsTracker && gpsTracker.wakeLock) {
                    wakeLockStatus.textContent = 'Active';
                    wakeLockStatus.style.background = '#4caf50';
                } else {
                    wakeLockStatus.textContent = wakeLockSupported ? 'Inactive' : 'Not Supported';
                    wakeLockStatus.style.background = '#f44336';
                }
            }
        }
        
        // Update wake lock status periodically
        setInterval(updateWakeLockStatus, 5000);
        
        // Page load performance
        window.addEventListener('load', function() {
            const loadTime = performance.now();
            console.log(`Page loaded in ${loadTime.toFixed(2)}ms`);
            
            // Show ready notification
            setTimeout(function() {
                if (gpsTracker) {
                    gpsTracker.showNotification('Ultra GPS Tracker Pro ready!', 'success');
                }
            }, 500);
        });
        
        // Storage quota management
        if ('storage' in navigator && 'estimate' in navigator.storage) {
            navigator.storage.estimate().then(function(estimate) {
                const used = Math.round(estimate.usage / 1024 / 1024);
                const quota = Math.round(estimate.quota / 1024 / 1024);
                console.log(`Storage: ${used}MB used of ${quota}MB available`);
                
                // Update storage indicator
                const storageIndicator = document.getElementById('storageIndicator');
                if (storageIndicator) {
                    storageIndicator.textContent = `${used}MB / ${quota}MB`;
                    
                    const percentage = (used / quota) * 100;
                    if (percentage > 80) {
                        storageIndicator.style.background = '#f44336';
                    } else if (percentage > 60) {
                        storageIndicator.style.background = '#ff9800';
                    } else {
                        storageIndicator.style.background = '#4caf50';
                    }
                }
            });
        }
        
        // Prevent zoom on mobile
        document.addEventListener('touchmove', function(event) {
            if (event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });
        
        // Handle orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                if (gpsTracker && gpsTracker.canvas) {
                    const container = gpsTracker.canvas.parentElement;
                    gpsTracker.canvas.width = container.clientWidth;
                    gpsTracker.canvas.height = container.clientHeight;
                    gpsTracker.drawTrack();
                }
            }, 100);
        });
        
        // Console welcome message
        console.log('🛰️ Ultra GPS Tracker Pro - Advanced Edition');
        console.log('Version: 3.0');
        console.log('Features: Dead Reckoning, Sensor Fusion, Enhanced Filtering');
        console.log('Controls:');
        console.log('  Ctrl+S: Start/Stop | Ctrl+P: Pause/Resume | Ctrl+E: Export');
        console.log('  F1: Help | Double-click title: Debug mode');
        console.log('Touch Gestures: Swipe for quick actions');
        console.log('Ready for precision GPS tracking! 🚀');
        
        // Initialize additional features
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips if library is available
            if (typeof initTooltips === 'function') {
                initTooltips();
            }
            
            // Initialize charts if library is available
            if (typeof initCharts === 'function') {
                initCharts();
            }
            
            // Start performance monitoring
            logMemoryUsage();
            logConnectionInfo();
            updateWakeLockStatus();
        });
    </script>
</body>
</html>









